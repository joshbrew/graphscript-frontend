function html(strings,...args){return function append(elm){let template=document.createElement("template");let rand=`e${`${Math.random()}`.substring(2)}`;let combinedHTML="";const withStr=(string,i3)=>{combinedHTML+=string;if(args[i3]instanceof HTMLElement){combinedHTML+=`<span id="${rand}"></span>`}else if(args[i3]!==void 0){combinedHTML+=args[i3]}};strings.forEach(withStr);template.innerHTML=combinedHTML;let dummyNodes=Array.from(template.content.querySelectorAll(`#${rand}`));const withArg=(arg,i3)=>{if(arg instanceof HTMLElement){let dummyNode=dummyNodes[i3];if(dummyNode){dummyNode.parentNode.replaceChild(arg,dummyNode)}}};args.forEach(withArg);if(elm){elm.appendChild(template.content);return elm}return template.content}}function xml(strings,...args){return function append(elm,namespace="http://www.w3.org/1999/xhtml"){let parser=new DOMParser;let serializer=new XMLSerializer;let xmlDoc=parser.parseFromString('<root xmlns="'+namespace+'"></root>',"application/xml");let template=xmlDoc.createElement("template");xmlDoc.documentElement.appendChild(template);for(let i3=0;i3<strings.length;i3++){let textNode=xmlDoc.createTextNode(strings[i3]);template.appendChild(textNode);if(i3<args.length){if(args[i3]instanceof Node){template.appendChild(args[i3])}else if(args[i3]!==void 0){let textNodeArg=xmlDoc.createTextNode(String(args[i3]));template.appendChild(textNodeArg)}}}if(elm){elm.appendChild(template);return serializer.serializeToString(elm)}return serializer.serializeToString(template)}}var htmlloader=(node,parent,graph,roots,properties,key)=>{if(node.__onresize){let onresize=node.__onresize;node.__onresize=ev=>{onresize.call(node,ev,node.__props)}}if(node.__onremove){let ondelete=node.__onremove;node.__onremove=element=>{ondelete.call(node,element)}}if(node.__onrender){let onrender=node.__onrender;node.__onrender=element=>{onrender.call(node,element)}}if(node.tagName||node.__element){if(node.tagName)node.__props=document.createElement(node.tagName);else if(node.__element){if(node.__element instanceof HTMLElement)node.__props=node.__element;else node.__props=document.createElement(node.__element)}if(!(node.__props instanceof HTMLElement))return}if(node.__props instanceof HTMLElement){let cpy=Object.assign({},node);let keys=Object.getOwnPropertyNames(cpy);for(const k2 of keys){if(k2==="style"&&typeof node[k2]==="object"){Object.assign(node.__props.style,cpy[k2])}else if(k2==="className")node.__props.setAttribute("class",cpy[k2]);else if(!k2.includes("outer"))node.__props[k2]=cpy[k2]}if(node.__attributes){for(const k2 in node.__attributes){if(k2==="style"&&typeof node.__attributes[k2]==="object"){Object.assign(node.__props.style,node.__attributes[k2])}else if(k2==="className")node.__props.setAttribute("class",node.__attributes[k2]);else if(!k2.includes("outer"))node.__props[k2]=node.__attributes[k2]}}node.__proxyObject(node.__props);for(const k2 of keys){if(typeof cpy[k2]==="function"){let fn=cpy[k2];node.__props[k2]=(...inp)=>{let res=fn(...inp);node.__node.state.triggerEvent(node.__node.unique+"."+k2,res)};node[k2]=node.__props[k2]}}if(node.__attributes){for(const k2 in node.__attributes){if(typeof cpy[k2]==="function"){let fn=node.__attributes[k2];node.__props[k2]=(...inp)=>{let res=fn(...inp);node.__node.state.triggerEvent(node.__node.unique+"."+k2,res)};node[k2]=node.__props[k2]}}}if(node.__onresize)window.addEventListener("resize",node.__onresize)}if(node.__props instanceof HTMLElement){node.__props.id=key;node.__props.node=node;node.__addOnconnected(n=>{if(!(node.__props instanceof HTMLBodyElement||node.__props instanceof HTMLHeadElement)&&n.__props.parentNode)n.__props.remove();if(properties.parentNode){if(typeof properties.parentNode==="string"&&document.getElementById(properties.parentNode))document.getElementById(properties.parentNode)?.appendChild(n.__props);else if(properties.parentNode instanceof HTMLElement)properties.parentNode.appendChild(n.__props)}else if(parent?.__props instanceof HTMLElement){parent.__props.appendChild(node.__props)}else if(typeof graph.parentNode==="string"&&document.getElementById(properties.parentNode)){document.getElementById(properties.parentNode)?.appendChild(graph.__props)}else if(graph.parentNode instanceof HTMLElement){graph.parentNode.appendChild(node.__props)}else if(!(node.__props instanceof HTMLBodyElement||node.__props instanceof HTMLHeadElement))document.body.appendChild(node.__props);if(node.__onrender)setTimeout(()=>{node.__onrender(node.__props)},.01)});node.__addOndisconnected(n=>{n.__props.remove();if(typeof n.__onremove==="function"){n.__onremove(n.__props)}if(n.__onresize){window.removeEventListener("resize",n.__onresize)}})}};var dummy=html``;var DOMElement=class extends HTMLElement{useShadow=false;FRAGMENT;STYLE;attachedShadow=false;static get tag(){return this.name.toLowerCase()+"-"}obsAttributes=["props","options","onchanged","onresize","ondelete","oncreate","template"];props={};static addElement(tag=this.tag,cls=this,extend=void 0){addCustomElement(cls,tag,extend)}attributeChangedCallback=(name,old,val)=>{if(name==="onchanged"){let onchanged=val;if(typeof onchanged==="string")onchanged=parseFunctionFromText(onchanged);if(typeof onchanged==="function"){this.onchanged=onchanged;this.state.data.props=this.props;this.state.unsubscribeTrigger("props");this.state.subscribeTrigger("props",this.onchanged);let changed=new CustomEvent("changed",{detail:{props:this.props,self:this}});this.state.subscribeTrigger("props",()=>{this.dispatchEvent(changed)})}}else if(name==="onresize"){let onresize=val;if(typeof onresize==="string")onresize=parseFunctionFromText(onresize);if(typeof onresize==="function"){if(this.ONRESIZE){try{window.removeEventListener("resize",this.ONRESIZE)}catch(err){}}this.ONRESIZE=ev=>{this.onresize(this.props,this)};this.onresize=onresize;window.addEventListener("resize",this.ONRESIZE)}}else if(name==="ondelete"){let ondelete=val;if(typeof ondelete==="string")ondelete=parseFunctionFromText(ondelete);if(typeof ondelete==="function"){this.ondelete=()=>{if(this.ONRESIZE)window.removeEventListener("resize",this.ONRESIZE);this.state.unsubscribeTrigger("props");if(ondelete)ondelete(this.props,this)}}}else if(name==="oncreate"){let oncreate=val;if(typeof oncreate==="string")oncreate=parseFunctionFromText(oncreate);if(typeof oncreate==="function"){this.oncreate=oncreate}}else if(name==="renderonchanged"){let rpc=val;if(typeof this.renderonchanged==="number")this.unsubscribeTrigger(this.renderonchanged);if(typeof rpc==="string")rpc=parseFunctionFromText(rpc);if(typeof rpc==="function"){this.renderonchanged=this.state.subscribeTrigger("props",p=>{this.render(p);rpc(this,p)})}else if(rpc!=false)this.renderonchanged=this.state.subscribeTrigger("props",this.render)}else if(name==="props"){let newProps=val;if(typeof newProps==="string")newProps=JSON.parse(newProps);Object.assign(this.props,newProps);this.state.setState({props:this.props})}else if(name==="template"){let template=val;this.template=template;this.render(this.props);let created=new CustomEvent("created",{detail:{props:this.props}});this.dispatchEvent(created)}else{let parsed=val;if(name.includes("eval_")){name=name.split("_");name.shift();name=name.join();parsed=parseFunctionFromText(val)}else if(typeof val==="string"){try{parsed=JSON.parse(val)}catch(err){parsed=val}}this[name]=parsed;if(name!=="props"&&this.props)this.props[name]=parsed}};connectedCallback(){if(!this.props)this.props={};let newProps=this.getAttribute("props");if(typeof newProps==="string")newProps=JSON.parse(newProps);Object.assign(this.props,newProps);this.state.setState({props:this.props});Array.from(this.attributes).forEach(att=>{let name=att.name;let parsed=att.value;if(name.includes("eval_")||name.includes("()")){if(name.includes("eval_"))name=name.split("_");else if(name.includes("()"))name=name.substring(0,name.indexOf("("));name.shift();name=name.join();parsed=parseFunctionFromText(att.value)}else if(typeof att.value==="string"){try{parsed=JSON.parse(att.value)}catch(err){parsed=att.value}}if(!this[name]){Object.defineProperties(this,att,{value:parsed,writable:true,get(){return this[name]},set(val){this.setAttribute(name,val)}})}this[name]=parsed;if(name!=="props")this.props[name]=parsed;this.obsAttributes.push(name)});let resizeevent=new CustomEvent("resized",{detail:{props:this.props,self:this}});let changed=new CustomEvent("changed",{detail:{props:this.props,self:this}});let deleted=new CustomEvent("deleted",{detail:{props:this.props,self:this}});let created=new CustomEvent("created",{detail:{props:this.props,self:this}});this.render(this.props);this.dispatchEvent(created);this.state.subscribeTrigger("props",()=>{this.dispatchEvent(changed)});if(typeof this.onresize==="function"){if(this.ONRESIZE){try{window.removeEventListener("resize",this.ONRESIZE)}catch(err){}}this.ONRESIZE=ev=>{this.onresize(this,this.props);this.dispatchEvent(resizeevent)};window.addEventListener("resize",this.ONRESIZE)}if(typeof this.ondelete==="function"){let ondelete=this.ondelete;this.ondelete=(props=this.props)=>{if(this.ONRESIZE)window.removeEventListener("resize",this.ONRESIZE);this.state.unsubscribeTrigger("props");this.dispatchEvent(deleted);ondelete(this,props)}}if(typeof this.onchanged==="function"){this.state.data.props=this.props;this.state.subscribeTrigger("props",this.onchanged)}if(this.renderonchanged){let rpc=this.renderonchanged;if(typeof this.renderonchanged==="number")this.unsubscribeTrigger(this.renderonchanged);if(typeof rpc==="string")rpc=parseFunctionFromText(rpc);if(typeof rpc==="function"){this.renderonchanged=this.state.subscribeTrigger("props",p=>{this.render(p);rpc(this,p)})}else if(rpc!==false)this.renderonchanged=this.state.subscribeTrigger("props",this.render)}}constructor(){super()}delete=()=>{this.remove();if(typeof this.ondelete==="function")this.ondelete(this.props)};render=(props=this.props)=>{const t=document.createElement("template");let usingHTMLFunction=this.template.prototype?.constructor?.name==dummy.prototype.constructor.name;if(typeof this.template==="function"){if(usingHTMLFunction){this.template(t.content)}else this.templateResult=this.template(this,props)}else this.templateResult=this.template;if(this.styles)this.templateResult=`<style>${this.styles}</style>${this.templateResult}`;if(!usingHTMLFunction){if(typeof this.templateResult==="string")t.innerHTML=this.templateResult;else if(this.templateResult instanceof HTMLElement||this.templateResult instanceof DocumentFragment){if(this.templateResult.parentNode){this.templateResult.parentNode.removeChild(this.templateResult)}t.content.appendChild(this.templateResult)}}const fragment=t.content;if(this.FRAGMENT){if(this.useShadow){if(this.STYLE)this.shadowRoot.removeChild(this.STYLE);this.FRAGMENT.forEach(c=>{this.shadowRoot.removeChild(c)})}else this.FRAGMENT.forEach(c=>{this.removeChild(c)})}if(this.useShadow){if(!this.attachedShadow){this.attachShadow({mode:"open"}).innerHTML="<slot></slot>";this.attachedShadow=true}if(this.styles){let style=document.createElement("style");style.textContent=this.styles;this.shadowRoot.prepend(style);this.STYLE=style}let len=fragment.childNodes.length;this.shadowRoot.prepend(fragment);this.FRAGMENT=Array.from(this.shadowRoot.childNodes).slice(0,len)}else{let len=fragment.childNodes.length;this.prepend(fragment);this.FRAGMENT=Array.from(this.childNodes).slice(0,len)}let rendered=new CustomEvent("rendered",{detail:{props:this.props,self:this}});this.dispatchEvent(rendered);if(this.oncreate)this.oncreate(this,props)};state={pushToState:{},data:{},triggers:{},setState(updateObj){Object.assign(this.pushToState,updateObj);if(Object.keys(this.triggers).length>0){for(const prop of Object.getOwnPropertyNames(this.triggers)){if(this.pushToState[prop]){this.data[prop]=this.pushToState[prop];delete this.pushToState[prop];this.triggers[prop].forEach(obj=>{obj.onchanged(this.data[prop])})}}}return this.pushToState},subscribeTrigger(key,onchanged=res=>{}){if(key){if(!this.triggers[key]){this.triggers[key]=[]}let l=this.triggers[key].length;this.triggers[key].push({idx:l,onchanged});return this.triggers[key].length-1}else return void 0},unsubscribeTrigger(key,sub){let triggers=this.triggers[key];if(triggers){if(!sub)delete this.triggers[key];else{let idx=void 0;let obj=triggers.find((o,i3)=>{if(o.idx===sub){idx=i3;return true}});if(obj)triggers.splice(idx,1);return true}}},subscribeTriggerOnce(key=void 0,onchanged=value=>{}){let sub;let changed=value=>{onchanged(value);this.unsubscribeTrigger(key,sub)};sub=this.subscribeTrigger(key,changed)}}};function addCustomElement(cls,tag,extend=null){try{if(extend){if(tag)window.customElements.define(tag,cls,{extends:extend});else window.customElements.define(cls.name.toLowerCase()+"-",cls,{extends:extend})}else{if(tag)window.customElements.define(tag,cls);else window.customElements.define(cls.name.toLowerCase()+"-",cls)}}catch(err){}}function parseFunctionFromText(method){let getFunctionBody=methodString=>{return methodString.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4")};let getFunctionHead=methodString=>{let startindex=methodString.indexOf(")");return methodString.slice(0,methodString.indexOf("{",startindex)+1)};let newFuncHead=getFunctionHead(method);let newFuncBody=getFunctionBody(method);let newFunc;try{if(newFuncHead.includes("function")){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody)}else{if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let varName=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(varName,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else{try{newFunc=(0,eval)(newFuncHead+newFuncBody+"}")}catch(err){newFunc=(0,eval)(method)}}}}catch(err){}return newFunc}var x=class{data={};triggers={};ctr=0;constructor(e){typeof e=="object"&&(this.data=e)}setState=e=>{Object.assign(this.data,e);let t=Object.getOwnPropertyNames(e);for(let n of t)this.triggerEvent(n,this.data[n]);if(this.triggers[G]){let n=r=>{r(e)},s=this.triggers[G].length;for(let r=s-1;r>=0;r--)n(this.triggers[G][r].onchange)}return this.data};setValue=(e,t)=>{this.data[e]=t,this.triggerEvent(e,t)};triggerEvent=(e,t)=>{if(this.triggers[e]){let n=r=>{r.onchange(t)},s=this.triggers[e].length;for(let r=s-1;r>=0;r--)n(this.triggers[e][r])}};subscribeState=e=>this.subscribeEvent(G,e);unsubscribeState=e=>this.unsubscribeEvent(G,e);subscribeEvent=(e,t,n,s)=>{if(e){n&&s&&!this.triggers[e]&&Object.defineProperty(this.data,e,{get:()=>n[s],set:_=>{n[s]=_},enumerable:true,configurable:true}),this.triggers[e]||(this.triggers[e]=[]);let r=this.ctr;return this.ctr++,this.triggers[e].push({sub:r,onchange:t}),r}else return};unsubscribeEvent=(e,t)=>{let n=this.triggers[e];if(n)if(t===void 0)delete this.triggers[e],delete this.data[e];else{let s,r=n.find((_,o)=>{if(_.sub===t)return s=o,true});return r&&n.splice(s,1),Object.keys(n).length===0&&(delete this.triggers[e],delete this.data[e]),this.onRemoved&&this.onRemoved(r),true}};subscribeEventOnce=(e,t)=>{let n,s=r=>{t(r),this.unsubscribeEvent(e,n)};return n=this.subscribeEvent(e,s),n};getEvent=(e,t)=>{if(typeof t!="number")return this.triggers[e];for(let n in this.triggers[e])if(this.triggers[e][n].sub===t)return this.triggers[e][n]};getSnapshot=()=>{let e={};for(let t in this.data)e[t]=this.data[t]};onRemoved};var G="*s";var q=new x;var w=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}};var y=class i{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:q};__children;__parent;__operator;__listeners;__props;__args;constructor(e,t,n){if(this.__setProperties(e,t,n),typeof e=="function"||e?.__callable){let s=new w;s.__call=(..._)=>this.__operator(..._);let r=new Proxy(s,{get:(_,o,a)=>Reflect.has(this,o)?Reflect.get(this,o,a):Reflect.get(_,o,a),set:(_,o,a,f)=>Reflect.has(this,o)?Reflect.set(this,o,a,f):Reflect.set(_,o,a,f)});return Object.setPrototypeOf(r,this),r}}get __graph(){return this.__node?.graph}set __graph(e){this.__node.graph=e}__setProperties=(e,t,n)=>{if((()=>{let r=e;typeof e=="function"?S(e)?e=new e:e={__operator:e,__node:{forward:true,tag:e.name}}:typeof e=="string"&&n?.get(e)&&(e=n.get(e)),"__node"in e||(e.__node={}),e.__node.initial||(e.__node.initial=r)})(),typeof e=="object"){let r=()=>{e.__node?.state?this.__node.state=e.__node.state:n&&(e.__node.state=n.__node.state)},_=()=>{e.__props&&(typeof e.__props=="function"&&(e.__props=new e.__props),typeof e.__props=="object"&&this.__proxyObject(e.__props))},o=()=>{e.__node.tag||(e.__operator?.name?e.__node.tag=e.__operator.name:e.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},a=()=>{typeof e.__node=="string"?n?.get(e.__node.tag)?e=n.get(e.__node.tag):e.__node={}:e.__node||(e.__node={}),n&&(e.__node.graph=n),e instanceof b&&(e.__node.source=e)},f=()=>{if(!e.__parent&&t&&(e.__parent=t),t?.__node&&!(t instanceof b||e instanceof b)&&(e.__node.tag=t.__node.tag+"."+e.__node.tag),t instanceof b&&e instanceof b&&(e.__node.loaders&&Object.assign(t.__node.loaders?t.__node.loaders:{},e.__node.loaders),t.__node.mapGraphs)){e.__node.nodes.forEach(h=>{t.set(e.__node.tag+"."+h.__node.tag,h)});let u=()=>{e.__node.nodes.forEach(h=>{t.__node.nodes.delete(e.__node.tag+"."+h.__node.tag)})};this.__addOndisconnected(u)}},l=()=>{if(typeof e.default=="function"&&!e.__operator&&(e.__operator=e.default),e.__operator){if(typeof e.__operator=="string"&&n){let u=n.get(e.__operator);u&&(e.__operator=u.__operator),!e.__node.tag&&e.__operator.name&&(e.__node.tag=e.__operator.name)}typeof e.__operator=="function"&&(e.__operator=this.__setOperator(e.__operator)),e.default&&(e.default=e.__operator)}},c=()=>{e.__node=Object.assign(this.__node,e.__node);let u=Object.getOwnPropertyNames(e).filter(h=>{if(!O[h])return true});for(let h of u)h in e&&h!=="name"&&(this[h]=e[h])},d=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(u=>u.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(u=>u.bind(this))))};r(),o(),_(),a(),f(),c(),d(),l()}};__subscribe=(e,t,n,s,r,_,o)=>{let a=(l,c=(u,h)=>h||u,d=e)=>{let u;if(_){let p=j(d,_,this.__node.graph);d=p.__callback,u=p.__args}let h=this.__node.state.subscribeEvent(l,d,this,t),g=this.__node.state.getEvent(l,h);return this.__listeners||(this.__listeners={}),this.__listeners[l]=this.__node.state.triggers[l],g&&(g.source=this.__node.tag,t&&(g.key=t),g.target=c(e,s),r&&(g.tkey=r),n&&(g.subInput=n),_&&(g.arguments=u,g.__args=_),o&&(g.__callback=o),g.node=this,g.graph=this.__node.graph),h},f=l=>{let c=this.__node.graph.get(l);if(!c&&l.includes(".")){s=l.substring(0,l.lastIndexOf("."));let d=this.__node.graph.get(l.substring(0,s));r=l.lastIndexOf(".")+1,d&&typeof d[t]=="function"&&(l=(...u)=>d[r](...u))}else c.__operator&&(l=c.__operator,r="__operator");return l};if(t){if((!this.__node.localState||!this.__node.localState[t])&&this.__addLocalState(this,t),typeof e=="string"){if(o=this.__node.tag+"."+e,r=e,s){if(this.__node.graph?.get(s)){let d=this.__node.graph?.get(s);if(typeof d[e]=="function"){let u=d[e];e=(...h)=>{u(...h)}}else{let u=e;e=g=>{d[u]=g}}}}else if(typeof this[e]=="function"){let d=this[e];e=(...u)=>{d(...u)}}else this.__node.graph?.get(e)&&(e=f(e));if(typeof e!="function")return}let l,c=n?this.__node.unique+"."+t+"input":this.__node.unique+"."+t;return typeof e=="function"&&!e?.__node?l=a(c,(d,u)=>u||d,e):e?.__node&&(l=a(c,(d,u)=>u||d.__node.unique,(...d)=>{e.__operator&&e.__operator(...d)})),l}else{if(typeof e=="string"&&(o=e,s||(s=e),this.__node.graph.get(e)&&(e=this.__node.graph.get(e)),r="__operator",typeof e!="object"))return;let l,c=n?this.__node.unique+"input":this.__node.unique;return typeof e=="function"&&!e?.__node?l=a(c,(d,u)=>u||d,e):e?.__node&&(l=a(c,(d,u)=>u||d.__node.unique,(...d)=>{e.__operator&&e.__operator(...d)})),l}};__unsubscribe=(e,t,n)=>t?this.__node.state.unsubscribeEvent(n?this.__node.unique+"."+t+"input":this.__node.unique+"."+t,e):this.__node.state.unsubscribeEvent(n?this.__node.unique+"input":this.__node.unique,e);__setOperator=e=>{e=e.bind(this),this.__args&&this.__node.graph&&(e=j(e,this.__args,this.__node.graph).__callback);let t=`${this.__node.unique}input`;if(this.__operator=(...n)=>{this.__node.state.triggers[t]&&this.__node.state.setValue(t,n);let s=e(...n);return this.__node.state.triggers[this.__node.unique]&&(typeof s?.then=="function"?s.then(r=>{r!==void 0&&this.__node.state.setValue(this.__node.unique,r)}).catch(console.error):s!==void 0&&this.__node.state.setValue(this.__node.unique,s)),s},this.__parent instanceof i&&!this.__subscribedToParent&&this.__parent.__operator){let n=this.__parent.__subscribe(this),s=()=>{this.__parent?.__unsubscribe(n),delete this.__subscribedToParent};this.__addOndisconnected(s),this.__subscribedToParent=true}return this.__operator};__addLocalState=(e,t)=>{if(!e)return;this.__node.localState||(this.__node.localState={});let n=this.__node.localState,s=(r,_)=>{let o=this.__node.unique+"."+_,a=`${o}input`,f,l,c,d;if(typeof r[_]=="function"&&_!=="__operator")this.__props?.[_]?c=this.__props:c=n,f=()=>c[_],l=u=>{this.__props?.[_]||(u=u.bind(this)),c[_]=(...h)=>{this.__node.state.triggers[a]&&this.__node.state.setValue(a,h);let g=u(...h);return this.__node.state.triggers[o]&&(typeof g?.then=="function"?g.then(p=>{this.__node.state.triggerEvent(o,p)}).catch(console.error):this.__node.state.triggerEvent(o,g)),g}},n[_]=r[_].bind(this),d={get:f,set:l,enumerable:true,configurable:true};else if(_!=="__graph"){let u,h,g;this.__props?.[_]?g=this.__props:g=n,u=()=>g[_],h=p=>{g[_]=p,this.__node.state.triggers[o]&&this.__node.state.triggerEvent(o,p)},n[_]=r[_],d={get:u,set:h,enumerable:true,configurable:true}}if(Object.defineProperty(r,_,d),typeof this.__node.initial=="object"){let u=Object.getOwnPropertyDescriptor(this.__node.initial,_);(u===void 0||u?.configurable)&&Object.defineProperty(this.__node.initial,_,d)}};if(t)s(e,t);else for(let r in e)s(e,r)};__proxyObject=e=>{let t=I(e);for(let n of t){let s={get:()=>e[n],set:r=>{e[n]=r},enumerable:true,configurable:true};if(Object.defineProperty(this,n,s),typeof this.__node.initial=="object"){let r=Object.getOwnPropertyDescriptor(this.__node.initial,n);(r===void 0||r?.configurable)&&Object.defineProperty(this.__node.initial,n,s)}}};__addOnconnected(e){e=e.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(e):typeof this.__onconnected=="function"?this.__onconnected=[e,this.__onconnected]:this.__onconnected=e}__addOndisconnected(e){e=e.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(e):typeof this.__ondisconnected=="function"?this.__ondisconnected=[e,this.__ondisconnected]:this.__ondisconnected=e}__callConnected(e=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let t=n=>{n(this)};this.__onconnected.forEach(t)}}__callDisconnected(e=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let t=n=>{n(this)};this.__ondisconnected.forEach(t)}}};var b=class i2{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:q,roots:{}};constructor(e){this.init(e)}init=e=>{if(e){let t=Object.assign({},e);delete t.roots,N(this.__node,t),e.roots&&this.load(e.roots)}};load=(e,t=false)=>{function n(_,o,a=true,f=true){if(f){_||(_={});for(let l in o)!l.startsWith("__")&&o[l]&&typeof o[l]=="object"?(_[l]=o[l],o[l]?.__children&&n({},o[l].__children,false,false)):typeof o[l]=="function"&&(_[l]=o[l]);n(_,o,true,false)}else if(o?.__children&&!a)o.__children?.constructor.name==="Object"?_.__children?.constructor.name==="Object"?_.__children=n(_.__children,o.__children,true,false):_.__children=n({},o.__children,true,false):_.__children=o.__children;else if(a)for(let l in o)!l.startsWith("__")&&o[l]&&typeof o[l]=="object"?(_[l]=Object.assign({},o[l]),o[l]?.__children&&(_[l].__children=n({},o[l].__children,false,false))):typeof o[l]=="function"&&(_[l]=o[l]);return _}this.__node.roots=n(this.__node.roots?this.__node.roots:{},e);let s=Object.assign({},e);s.__node&&delete s.__node;let r=this.recursiveSet(s,this,void 0,e,t);if(e.__node){if(!e.__node.tag)e.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(e.__node.tag)){let _=new y(e,this,this);this.set(_.__node.tag,_),this.runLoaders(_,this,e,e.__node.tag),_.__listeners&&(r[_.__node.tag]=_.__listeners)}}else e.__listeners&&this.setListeners(e.__listeners);return this.setListeners(r),s};setLoaders=(e,t)=>(t?this.__node.loaders=e:Object.assign(this.__node.loaders,e),this.__node.loaders);runLoaders=(e,t,n,s)=>{for(let r in this.__node.loaders)typeof this.__node.loaders[r]=="object"?(this.__node.loaders[r].init&&this.__node.loaders[r](e,t,this,this.__node.roots,n,s),this.__node.loaders[r].connected&&e.__addOnconnected(this.__node.loaders[r].connect),this.__node.loaders[r].disconnected&&e.__addOndisconnected(this.__node.loaders[r].disconnect)):typeof this.__node.loaders[r]=="function"&&this.__node.loaders[r](e,t,this,this.__node.roots,n,s)};add=(e,t,n=true)=>{let s={};typeof t=="string"&&(t=this.get(t));let r;if(typeof e=="function"?S(e)?e.prototype instanceof y?(e=e.prototype.constructor(e,t,this),r=true):e=new e:e={__operator:e,__callable:true}:typeof e=="string"&&(e=this.__node.roots[e]),!e)return;if(!r){let a=Object.getOwnPropertyNames(e),f=Object.getOwnPropertyNames(Object.getPrototypeOf(e));a.push(...f),a=a.filter(c=>!O.includes(c));let l={};for(let c of a)l[c]=e[c];e=l}if(e.__node||(e.__node={}),e.__node.initial=e,typeof e=="object"&&this.get(e.__node.tag))if(n)this.remove(e.__node.tag,true);else return;else if(e.__node.tag&&this.get(e.__node.tag))return this.get(e.__node.tag);let _,o=N({},e,2);if(r?_=e:_=new y(e,t,this),this.set(_.__node.tag,_),this.runLoaders(_,t,e,_.__node.tag),this.__node.roots[_.__node.tag]=o,_.__children&&(_.__children=Object.assign({},_.__children),this.recursiveSet(_.__children,_,s,_.__children)),_.__listeners){s[_.__node.tag]=Object.assign({},_.__listeners);for(let a in _.__listeners){let f=_.__listeners[a];_[a]&&(delete s[_.__node.tag][a],s[_.__node.tag][_.__node.tag+"."+a]=f),typeof f=="string"&&(_.__children?.[f]?s[_.__node.tag][a]=_.__node.tag+"."+f:t instanceof y&&(t.__node.tag===f||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===f)&&(s[_.__node.tag][a]=t.__node.tag))}}return this.setListeners(s),_.__callConnected(),_};recursiveSet=(e,t,n={},s,r=false)=>{let _=Object.getOwnPropertyNames(s).filter(a=>!O.includes(a)),o=Object.getOwnPropertyNames(Object.getPrototypeOf(s)).filter(a=>!O.includes(a));_.push(...o);for(let a of _){if(a.includes("__"))continue;let f=s[a];if(Array.isArray(f))continue;let l;if(typeof f=="function"?S(f)?(f=new f,f instanceof y&&(f=f.prototype.constructor(f,t,this),l=true)):f={__operator:f,__callable:true}:typeof f=="string"?this.__node.nodes.get(f)?f=this.__node.nodes.get(f):f=this.__node.roots[f]:typeof f=="boolean"&&(this.__node.nodes.get(a)?f=this.__node.nodes.get(a):f=this.__node.roots[a]),f&&typeof f=="object"){if(!l&&!(f instanceof y)){let h=Object.getOwnPropertyNames(f).filter(m=>!O.includes(m)),g=Object.getOwnPropertyNames(Object.getPrototypeOf(f)).filter(m=>!O.includes(m));g.splice(g.indexOf("constructor"),1),h.push(...g);let p={};for(let m of h)p[m]=f[m];f=p}if(f.__node||(f.__node={}),f.__node.tag||(f.__node.tag=a),f.__node.initial||(f.__node.initial=e[a]),r&&this.get(f.__node.tag))this.remove(f.__node.tag,true);else if(this.get(f.__node.tag)&&!(!(t instanceof i2)&&t?.__node)||t?.__node&&this.get(t.__node.tag+"."+f.__node.tag))continue;let c,d=false,u=N({},f,2);if(l||f instanceof y?c=f:(c=new y(f,t,this),d=true),!d&&f instanceof y&&!l&&t instanceof y){let h=this.subscribe(t.__node.tag,c.__node.tag),g=p=>{this.unsubscribe(t.__node.tag,h)};c.__addOndisconnected(g)}else if(c){if(this.set(c.__node.tag,c),this.runLoaders(c,t,e[a],a),e[a]=c,this.__node.roots[c.__node.tag]=u,c.__children&&(c.__children=Object.assign({},c.__children),this.recursiveSet(c.__children,c,n,c.__children)),c.__listeners){n[c.__node.tag]=Object.assign({},c.__listeners);for(let h in c.__listeners){let g=c.__listeners[h],p=h;c[h]&&(delete n[c.__node.tag][h],p=c.__node.tag+"."+h,n[c.__node.tag][p]=g),typeof g=="string"&&(c.__children?.[g]?n[c.__node.tag][p]=c.__node.tag+"."+g:t instanceof y&&(t.__node.tag===g||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===g)&&(n[c.__node.tag][p]=t.__node.tag))}}c.__callConnected()}}}return n};remove=(e,t=true)=>{if(this.unsubscribe(e),typeof e=="string"&&(e=this.get(e)),e instanceof y){this.delete(e.__node.tag),delete this.__node.roots[e.__node.tag],t&&this.clearListeners(e),e.__callDisconnected();let n=s=>{for(let r in s)this.unsubscribe(s[r]),this.delete(s[r].__node.tag),delete this.__node.roots[s[r].__node.tag],this.delete(r),delete this.__node.roots[r],s[r].__node.tag=s[r].__node.tag.substring(s[r].__node.tag.lastIndexOf(".")+1),t&&this.clearListeners(s[r]),s[r].__callDisconnected(),s[r].__children&&n(s[r].__children)};e.__children&&n(e.__children)}return e?.__node.tag&&e?.__parent&&(delete e?.__parent,e.__node.tag=e.__node.tag.substring(e.__node.tag.indexOf(".")+1)),e?.__node.graph&&(e.__node.graph=void 0),e};run=(e,...t)=>{if(typeof e=="string"){let n=this.get(e);if(!n&&e.includes(".")){if(n=this.get(e.substring(0,e.lastIndexOf("."))),typeof n?.[e.substring(e.lastIndexOf(".")+1)]=="function")return n[e.substring(e.lastIndexOf(".")+1)](...t)}else if(n?.__operator)return n.__operator(...t)}if(e?.__operator)return e?.__operator(...t)};setListeners=e=>{for(let t in e){let n=this.get(t);if(typeof e[t]=="object")for(let s in e[t]){let r=this.get(s),_;if(typeof e[t][s]!="object")e[t][s]={__callback:e[t][s]};else if(!e[t][s].__callback)for(let o in e[t][s]){typeof e[t][s][o]!="object"&&(e[t][s][o]={__callback:e[t][s][o]},n.__operator&&(e[t][s][o].__callback===true||typeof e[t][s][o].__callback>"u")&&(e[t][s][o].__callback=n.__operator));let a=this.get(o);if(a)_=this.subscribe(a,e[t][s][o].__callback,e[t][s][o].__args,void 0,e[t][s][o].subInput,t);else{let f=s.substring(0,s.lastIndexOf("."));if(a=this.get(f),a){let l=s.substring(s.lastIndexOf(".")+1);_=this.subscribe(a,e[t][s][o].__callback,e[t][s][o].__args,l,e[t][s][o].subInput,t)}}}if("__callback"in e[t][s])if(n&&((e[t][s].__callback===true||typeof e[t][s].__callback>"u")&&(e[t][s].__callback=n.__operator),typeof e[t][s].__callback=="function"&&(e[t][s].__callback=e[t][s].__callback.bind(n))),r)_=this.subscribe(r,e[t][s].__callback,e[t][s].__args,void 0,e[t][s].subInput,t);else{let o=s.substring(0,s.lastIndexOf("."));r=this.get(o),r&&(_=this.subscribe(r,e[t][s].__callback,e[t][s].__args,s.substring(s.lastIndexOf(".")+1),e[t][s].subInput,t))}}}};clearListeners=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e?.__listeners)for(let n in e.__listeners){if(t&&n!==t||typeof e.__listeners[n]?.sub!="number")continue;let s=this.get(n);if(s)if(typeof!e.__listeners[n]?.__callback=="number")for(let r in e.__listeners[n])e.__listeners[n][r]?.sub&&(this.unsubscribe(s,e.__listeners[n][r].sub,void 0,e.__listeners[n][r].subInput),e.__listeners[n][r].sub=void 0);else typeof e.__listeners[n]?.sub=="number"&&(this.unsubscribe(s,e.__listeners[n].sub,void 0,e.__listeners[n].subInput),e.__listeners[n].sub=void 0);else if(s=this.get(n.substring(0,n.lastIndexOf("."))),s)if(typeof e.__listeners[n]=="object"&&!e.__listeners[n]?.__callback)for(let r in e.__listeners[n])typeof e.__listeners[n][r]?.sub=="number"&&(this.unsubscribe(s,e.__listeners[n][r].sub,n.substring(n.lastIndexOf(".")+1),e.__listeners[n][r].subInput),e.__listeners[n][r].sub=void 0);else typeof e.__listeners[n]?.sub=="number"&&(this.unsubscribe(s,e.__listeners[n].sub,n.substring(n.lastIndexOf(".")+1),e.__listeners[n].subInput),e.__listeners[n].sub=void 0)}};get=e=>this.__node.nodes.get(e);getByUnique=e=>Array.from(this.__node.nodes.values()).find(t=>{if(t.__node.unique===e)return true});set=(e,t)=>this.__node.nodes.set(e,t);delete=e=>this.__node.nodes.delete(e);list=()=>Array.from(this.__node.nodes.keys());getListener=(e,t,n)=>{let s=this.get(e);if(s){let r=s.__node.unique;return t&&(r+="."+t),this.__node.state.getEvent(r,n)}};getProps=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e instanceof y){let n;if(t)n=Object.assign({},this.__node.roots[e.__node.tag]);else{n=Object.assign({},e);for(let s in n)s.includes("__")&&delete n[s]}}};subscribe=(e,t,n,s,r,_,o)=>{let a=e;typeof e=="string"&&(a=this.get(e),!a&&e.includes(".")&&(a=this.get(e.substring(0,e.lastIndexOf("."))),s=e.substring(e.lastIndexOf(".")+1))),_ instanceof y&&(_=_.__node.tag);let f;if(typeof t=="string"){f=t;let c=d=>{if(this.get(d)?.__operator){let u=this.get(d);_=d,d=function(...h){return u.__operator(...h)}}else if(d.includes(".")){_=d.substring(0,d.lastIndexOf("."));let u=this.get(_),h=d.substring(d.lastIndexOf(".")+1);o=h,typeof u[h]=="function"?u[h]instanceof y?d=u[h]:d=function(...g){return u[h](...g)}:d=function(g){return u[h]=g,u[h]}}return d};if(_){let d=this.get(_);typeof d?.[t]=="function"?(o=t,t=function(...u){return d[s](...u)}):d?.[s]?(o=s,d[s]instanceof y?t=d[s]:t=function(u){return d[s]=u,d[s]}):t=c(t)}else t=c(t)}let l;if(a instanceof y){let c=()=>{l=a.__subscribe(t,s,r,_,o,n,f);let d=()=>{l!==void 0&&a.__unsubscribe(l,s,r),l=void 0};a.__addOndisconnected(()=>{d(),a.__addOnconnected(()=>{l===void 0&&a.__node.graph.__node.tag===this.__node.tag&&c()})}),typeof t=="string"&&this.get(t)&&(t=this.get(t)),t instanceof y&&t.__addOndisconnected(()=>{d()})};c()}else if(typeof e=="string"){let c=this.get(e);if(c){if(t instanceof y&&t.__operator){let d=()=>{l=c.__subscribe(t.__operator,s,r,_,o,n,f);let u=()=>{l!==void 0&&c.__unsubscribe(l,s,r)};c.__addOndisconnected(()=>{u(),c.__addOnconnected(()=>{l===void 0&&c.__node.graph.__node.tag===this.__node.tag&&d()})}),t.__addOndisconnected(u)};d()}else if(typeof t=="function"||typeof t=="string"){let d=()=>{l=c.__subscribe(t,s,r,_,o,n,f);let u=()=>{l!==void 0&&c.__unsubscribe(l,s,r),l=void 0};c.__addOndisconnected(()=>{u(),c.__addOnconnected(()=>{l===void 0&&c.__node.graph.__node.tag===this.__node.tag&&d()})}),typeof t=="string"&&this.get(t)&&this.get(t).__addOndisconnected(u)};d()}}else typeof t=="string"&&(t=this.__node.nodes.get(t).__operator),typeof t=="function"&&!t?.__node&&(l=this.__node.state.subscribeEvent(e,t))}return l};unsubscribe=(e,t,n,s)=>e instanceof y?e.__unsubscribe(t,n,s):this.get(e)?.__unsubscribe(t,n,s);setState=e=>{this.__node.state.setState(e)}};function N(i3,e,t=1/0,n=0){for(let s in e)e[s]?.constructor.name==="Object"&&n<t?(n++,i3[s]?.constructor.name==="Object"?N(i3[s],e[s],t,n):i3[s]=N({},e[s],t,n)):i3[s]=e[s];return i3}function I(i3){var e=[],t=i3;do{var n=Object.getOwnPropertyNames(t);let s=function(r){e.indexOf(r)===-1&&e.push(r)};n.forEach(s)}while(t=Object.getPrototypeOf(t));return e}function S(i3){return R(i3)==="class"}function R(i3){return typeof i3=="function"?i3.prototype?Object.getOwnPropertyDescriptor(i3,"prototype")?.writable?"function":"class":i3.constructor.name==="AsyncFunction"?"async":"arrow":""}var A=(i3,e)=>{if(e.get(i3)?.__operator){let t=e.get(i3);return(...n)=>{t.__operator(...n)}}else if(i3.includes(".")){let t=i3.split("."),n=t.pop(),s=t.join("."),r=e.get(s);return typeof e.get(s)?.[n]=="function"?(..._)=>r[n](..._):()=>r[n]}else if(e.get(i3)){let t=e.get(i3);return()=>t}else{let t=i3;return()=>t}};var j=(i3,e,t)=>{let n=[],s=(_,o)=>{if(_==="__output"||_==="__input"||_==="__callback")n[o]={__callback:a=>a,__args:void 0,idx:o};else if(typeof _=="string")n[o]={__callback:A(_,t),__args:void 0,idx:o};else if(typeof _=="function"){let a=_;n[o]={__callback:(...f)=>a(...f),__args:void 0,idx:o}}else if(typeof _=="object"&&(_.__input||_.__callback)){let a=function(f){let l=f.__input?f.__input:f.__callback;if(typeof f.__input=="string"&&(l={__callback:A(f.__input,t),__args:void 0,idx:o}),f.__args){let c=j(l,f.__args,t);l={__callback:c.__callback,__args:c.__args,idx:o}}else l={__callback:l,__args:void 0,idx:o};if(f.__output){let c=f.__output;if(typeof f.__output=="string"?c={__callback:A(c,t),__args:void 0,idx:o}:typeof _.__output=="object"&&(c=a(c)),typeof c?.__callback=="function"){let d=l.__callback,u=c.__callback;l={__callback:(...h)=>u(d(...h)),__args:c.__args,idx:o}}}return l};n[o]=a(_)}else{let a=_;n[o]={__callback:()=>a,__args:void 0,idx:o}}};e.forEach(s),typeof i3=="string"&&(i3={__callback:A(i3,t),__args:void 0});let r=typeof i3=="function"?i3:i3.__callback;return i3=function(..._){let o=f=>f.__callback(..._);return r(...n.map(o))},{__callback:i3,__args:n}};var O=Object.getOwnPropertyNames(Object.getPrototypeOf({}));var C=(i3,e,t)=>{i3.__node.backward&&e instanceof y&&t.setListeners({[e.__node.tag]:{[i3.__node.tag]:e}})};var T=(i3,e,t)=>{if(i3.__operator){let n=Math.random();if(i3.__node.loops||(i3.__node.loops={}),typeof i3.__node.delay=="number"){let s=i3.__operator;i3.__setOperator((...r)=>new Promise((_,o)=>{i3.__node.loops[n]=setTimeout(async()=>{_(await s(...r))},i3.__node.delay)}))}else if(i3.__node.frame===true){let s=i3.__operator;i3.__setOperator((...r)=>new Promise((_,o)=>{i3.__node.loops[n]=requestAnimationFrame(async()=>{_(await s(...r))})}))}if(typeof i3.__node.repeat=="number"||typeof i3.__node.recursive=="number"){let s=i3.__operator;i3.__setOperator(async(...r)=>{let _=i3.__node.repeat?i3.__node.repeat:i3.__node.recursive,o,a=async(f,...l)=>{for(;f>0;){if(i3.__node.delay||i3.__node.frame){s(...l).then(async c=>{i3.__node.recursive?await a(f,c):await a(f,...l)});break}else o=await s(...r);f--}};return await a(_,...r),o})}if(i3.__node.loop&&typeof i3.__node.loop=="number"){let s=i3.__operator,r=i3.__node.loop;i3.__setOperator((...o)=>{if("looping"in i3.__node||(i3.__node.looping=true),i3.__node.looping){let a=performance.now();s(...o),i3.__node.loops[n]=setTimeout(()=>{let l=performance.now()-a-i3.__node.loop;l>0?r=i3.__node.loop-l:r=i3.__node.loop,r<=0&&(r=i3.__node.loop),i3.__operator(...o)},r)}}),i3.__node.looping&&i3.__operator();let _=o=>{o.__node.looping&&(o.__node.looping=false),o.__node.loops[n]&&(clearTimeout(o.__node.loops[n]),cancelAnimationFrame(o.__node.loops[n]))};i3.__addOndisconnected(_)}}};var $=(i3,e,t)=>{if(i3.__node.animate===true||i3.__animation){let n=i3.__operator;i3.__setOperator((...r)=>{"animating"in i3.__node||(i3.__node.animating=true),i3.__node.animating&&(typeof i3.__animation=="function"?i3.__animation(...r):n(...r),i3.__node.animationFrame=requestAnimationFrame(()=>{i3.__operator(...r)}))}),(i3.__node.animating||(!("animating"in i3.__node)||i3.__node.animating)&&i3.__animation)&&setTimeout(()=>{i3.__node.animationFrame=requestAnimationFrame(i3.__operator)},10);let s=r=>{r.__node.animating&&(r.__node.animating=false),r.__node.animationFrame&&cancelAnimationFrame(r.__node.animationFrame)};i3.__addOndisconnected(s)}};var J=(i3,e,t)=>{if(typeof i3.__branch=="object"&&i3.__operator&&!i3.__branchApplied){let n=i3.__operator;i3.__branchApplied=true,i3.__operator=(...s)=>{let r=n(...s);for(let _ in i3.__branch){let o=()=>{typeof i3.__branch[_].then=="function"?i3.__branch[_].then(r):i3.__branch[_].then instanceof y&&i3.__branch[_].then.__operator?i3.__branch[_].then.__operator(r):r=i3.__branch[_].then};typeof i3.__branch[_].if=="function"?i3.__branch[_].if(r)==true&&o():i3.__branch[_].if===r&&o()}return r}}if(i3.__listeners){for(let n in i3.__listeners)if(typeof i3.__listeners[n]=="object"&&i3.__listeners[n].branch&&!i3.__listeners[n].branchApplied){let s=i3.__listeners[n].callback;i3.__listeners[n].branchApplied=true,i3.__listeners.callback=r=>{let _=()=>{typeof i3.__listeners[n].branch.then=="function"?r=i3.__listeners[n].branch.then(r):i3.__listeners[n].branch.then instanceof y&&i3.__listeners[n].branch.then.__operator?r=i3.__listeners[n].branch.then.__operator(r):r=i3.__listeners[n].branch.then};return typeof i3.__listeners[n].branch.if=="function"?i3.__listeners[n].branch.if(r)&&_():i3.__listeners[n].branch.if===r&&_(),s(r)}}}};var W=(i3,e,t)=>{if(i3.__listeners)for(let n in i3.__listeners)typeof i3.__listeners[n]=="object"&&i3.__listeners[n].oncreate&&i3.__listeners[n].callback(i3.__listeners[n].oncreate)};var V=(i3,e,t)=>{if(i3.__listeners)for(let n in i3.__listeners)typeof i3.__listeners[n]=="object"&&typeof i3.__listeners[n].binding=="object"&&(i3.__listeners.callback=i3.__listeners.callback.bind(i3.__listeners[n].binding))};var B=(i3,e,t)=>{if(i3.__listeners){for(let n in i3.__listeners)if(typeof i3.__listeners[n]=="object"&&typeof i3.__listeners[n].transform=="function"&&!i3.__listeners[n].transformApplied){let s=i3.__listeners[n].callback;i3.__listeners[n].transformApplied=true,i3.__listeners.callback=r=>(r=i3.__listeners[n].transform(r),s(r))}}};var H=(i3,e,t)=>{i3.post&&!i3.__operator?i3.__setOperator(i3.post):!i3.__operator&&typeof i3.get=="function"&&i3.__setOperator(i3.get),!i3.get&&i3.__operator,i3.aliases&&i3.aliases.forEach(n=>{t.set(n,i3);let s=r=>{t.__node.nodes.delete(n)};i3.__addOndisconnected(s)}),typeof t.__node.roots?.[i3.__node.tag]=="object"&&i3.get&&(t.__node.roots[i3.__node.tag].get=i3.get)};var F={backprop:C,loop:T,animate:$,branching:J,triggerListenerOncreate:W,bindListener:V,transformListenerResult:B,substitute__operator:H};var k=function(){let i3=new Map,e=[],t=["this"];function n(){i3.clear(),e.length=0,t.length=1}function s(_,o){var a=e.length-1,f=e[a];if(typeof f=="object")if(f[_]===o||a===0)t.push(_),e.push(o.pushed);else for(;a-->=0;){if(f=e[a],typeof f=="object"&&f[_]===o){a+=2,e.length=a,t.length=a,--a,e[a]=o,t[a]=_;break}a--}}function r(_,o){if(o!=null&&typeof o=="object"){_&&s(_,o);let a=i3.get(o);if(a)return"[Circular Reference]"+a;i3.set(o,t.join("."))}return o}return function(o,a){try{return e.push(o),JSON.stringify(o,r,a)}finally{n()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=k);var z=function(){let i3=new Map,e=[],t=["this"];function n(){i3.clear(),e.length=0,t.length=1}function s(_,o){var a=e.length-1,f=e[a];if(typeof f=="object")if(f[_]===o||a===0)t.push(_),e.push(o.pushed);else for(;a-->=0;){if(f=e[a],typeof f=="object"&&f[_]===o){a+=2,e.length=a,t.length=a,--a,e[a]=o,t[a]=_;break}a--}}function r(_,o){if(o!=null&&typeof o=="object"){_&&s(_,o);let a=i3.get(o);if(a)return"[Circular Reference]"+a;i3.set(typeof o=="function"?o.toString():o,t.join("."))}return typeof o=="function"?o.toString():o}return function(o,a){try{return e.push(o),JSON.stringify(o,r,a)}finally{n()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=z);var Q=function(){let i3=new Map,e=[],t=["this"];function n(){i3.clear(),e.length=0,t.length=1}function s(_,o){var a=e.length-1;if(e[a]){var f=e[a];if(typeof f=="object")if(f[_]===o||a===0)t.push(_),e.push(o.pushed);else for(;a-->=0;){if(f=e[a],typeof f=="object"&&f[_]===o){a+=2,e.length=a,t.length=a,--a,e[a]=o,t[a]=_;break}a++}}}function r(_,o){let a;if(o!=null)if(typeof o=="object"){let f=o.constructor.name;_&&f==="Object"&&s(_,o);let l=i3.get(o);if(l)return"[Circular Reference]"+l;if(i3.set(o,t.join(".")),f==="Array")o.length>20?a=o.slice(o.length-20):a=o;else if(f.includes("Set"))a=Array.from(o);else if(f!=="Object"&&f!=="Number"&&f!=="String"&&f!=="Boolean")a="instanceof_"+f;else if(f==="Object"){let c={};for(let d in o)if(o[d]==null)c[d]=o[d];else if(Array.isArray(o[d]))o[d].length>20?c[d]=o[d].slice(o[d].length-20):c[d]=o[d];else if(o[d].constructor.name==="Object"){c[d]={};for(let u in o[d])if(Array.isArray(o[d][u]))o[d][u].length>20?c[d][u]=o[d][u].slice(o[d][u].length-20):c[d][u]=o[d][u];else if(o[d][u]!=null){let h=o[d][u].constructor.name;h.includes("Set")?c[d][u]=Array.from(o[d][u]):h!=="Number"&&h!=="String"&&h!=="Boolean"?c[d][u]="instanceof_"+h:c[d][u]=o[d][u]}else c[d][u]=o[d][u]}else{let u=o[d].constructor.name;u.includes("Set")?c[d]=Array.from(o[d]):u!=="Number"&&u!=="String"&&u!=="Boolean"?c[d]="instanceof_"+u:c[d]=o[d]}a=c}else a=o}else a=o;return a}return function(o,a){e.push(o);let f=JSON.stringify(o,r,a);return n(),f}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=Q);var L=class extends b{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(e){super({...e,loaders:e?.loaders?Object.assign({...F},e.loaders):{...F}}),e?.services&&this.addServices(e.services),e?.restrict&&(this.restrict=e.restrict),this.load(this)}addServices=e=>{for(let t in e)if(typeof e[t]=="function"&&(e[t]=new e[t]),e[t]?.__node?.loaders&&Object.assign(this.__node.loaders,e[t].__node.loaders),e[t]?.__node?.nodes){e[t].__node.nodes.forEach((r,_)=>{this.get(_)?this.set(t+"."+_,r):this.set(_,r)}),this.__node.nodes.forEach((r,_)=>{e[t].__node.nodes.get(_)||e[t].__node.nodes.set(_,r)});let n=this.set;this.set=(r,_)=>(e[t].set(r,_),n(r,_));let s=this.delete;this.delete=r=>(e[t].delete(r),s(r))}else typeof e[t]=="object"&&this.load(e[t])};handleMethod=(e,t,n)=>{let s=t.toLowerCase(),r=this.__node.nodes.get(e);if(r||(r=this.__node.roots[e]),r?.[s])if(typeof r[s]!="function"){if(n){Array.isArray(n)&&n.length===1?r[s]=n[0]:r[s]=n;return}return r[s]}else return Array.isArray(n)?r[s](...n):r[s](n);else return this.handleServiceMessage({route:e,args:n,method:t})};handleServiceMessage(e){let t;return typeof e=="object"&&(e.route?t=e.route:e.node&&(t=e.node)),t?Array.isArray(e.args)?this.run(t,...e.args):this.run(t,e.args):e}handleGraphNodeCall(e,t){if(!e)return t;if(t?.args)this.handleServiceMessage(t);else return Array.isArray(t)?this.run(e,...t):this.run(e,t)}transmit=(...e)=>{if(typeof e[0]=="object"){let t=e[0];if(t.method)return this.handleMethod(t.route,t.method,t.args);if(t.route)return this.handleServiceMessage(t);if(t.node)return this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}else return};receive=(...e)=>{if(e[0]){let t=e[0];if(typeof t=="string"){let n=t.substring(0,8);(n.includes("{")||n.includes("["))&&(n.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}if(typeof t=="object"){if(t.method)return this.restrict?.[t.route]?void 0:this.handleMethod(t.route,t.method,t.args);if(t.route)return this.restrict?.[t.route]?void 0:this.handleServiceMessage(t);if(t.node)return typeof t.node=="string"&&this.restrict?.[t.node]?void 0:this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}}};pipe=(e,t,n,s,r)=>{if(e instanceof y)return r?this.subscribe(e,_=>{let o=r(_);o!==void 0?this.transmit({route:t,args:o,method:s}):this.transmit({route:t,args:_,method:s},n)}):this.subscribe(e,_=>{this.transmit({route:t,args:_,method:s},n)});if(typeof e=="string")return this.subscribe(e,_=>{this.transmit({route:t,args:_,method:s},n)})};pipeOnce=(e,t,n,s,r)=>{if(e instanceof y)return r?e.__node.state.subscribeEventOnce(e.__node.unique,_=>{let o=r(_);o!==void 0?this.transmit({route:t,args:o,method:s}):this.transmit({route:t,args:_,method:s},n)}):this.__node.state.subscribeEventOnce(e.__node.unique,_=>{this.transmit({route:t,args:_,method:s},n)});if(typeof e=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(e).__node.unique,_=>{this.transmit({route:t,args:_,method:s},n)})};terminate=(...e)=>{};isTypedArray=X;recursivelyAssign=M;spliceTypedArray=Y;ping=()=>(console.log("pinged!"),"pong");echo=(...e)=>(this.transmit(...e),e);log=(...e)=>(console.log(...e),true);error=(...e)=>(console.error(...e),true)};function X(i3){return ArrayBuffer.isView(i3)&&Object.prototype.toString.call(i3)!=="[object DataView]"}var M=(i3,e)=>{for(let t in e)e[t]?.constructor.name==="Object"&&!Array.isArray(e[t])?i3[t]?.constructor.name==="Object"&&!Array.isArray(i3[t])?M(i3[t],e[t]):i3[t]=M({},e[t]):i3[t]=e[t];return i3};function Y(i3,e,t){let n=i3.subarray(0,e),s;t&&(s=i3.subarray(t+1));let r;return(n.length>0||s?.length>0)&&(r=new i3.constructor(n.length+s.length)),r&&(n.length>0&&r.set(n),s&&s.length>0&&r.set(s,n.length)),r}var wchtmlloader=(node,parent,graph,roots,properties,key)=>{if(node.__onresize){let onresize=node.__onresize;node.__onresize=ev=>{onresize.call(node,ev,node.__props)}}if(node.__onremove){let ondelete=node.__onremove;node.__onremove=element=>{ondelete.call(node,element)}}if(node.__onrender){let onrender=node.__onrender;node.__onrender=element=>{onrender.call(node,element)}}if((node.tagName||node.__element)&&!node.__props&&!node.__template){if(node.tagName)node.__props=document.createElement(node.tagName);else if(node.__element){if(node.__element instanceof HTMLElement)node.__props=node.__element;else node.__props=document.createElement(node.__element)}if(!(node.__props instanceof HTMLElement))return}else if(typeof node.__css==="string"){node.__template+=`<style> ${node.__css} </style>`;delete node.__css}const registerElement=(node2,tagNameOverride)=>{if(S(node2))node2=new node2;else if(typeof node2==="function"&&!node2.__node)node2=node2();class CustomElement extends DOMElement{props=node2.props;styles=node2.__css;useShadow=node2.useShadow;template=node2.__template;oncreate=node2.__onrender;onresize=node2.__onresize;ondelete=node2.__onremove;renderonchanged=node2.__renderonchanged}if(tagNameOverride?.includes("-"))node2.tagName=tagNameOverride;else if(node2.__element)node2.tagName=node2.__element;if(!node2.tagName)node2.tagName=`element${Math.floor(Math.random()*1e15)}-`;CustomElement.addElement(node2.tagName)};if("__components"in node){if(Array.isArray(node.__components))node.__components.forEach(c=>registerElement(c));else Object.entries(node.__components).forEach(([k2,c])=>registerElement(c,k2.includes("-")?k2:void 0))}if("__template"in node){if(typeof node.__renderonchanged==="function"){let renderonchanged=node.__renderonchanged;node.__renderonchanged=element=>{renderonchanged.call(element.node,element)}}registerElement(node);node.__props=document.createElement(node.tagName);let cpy=Object.assign({},node);let keys=Object.getOwnPropertyNames(cpy);for(const k2 of keys){if(k2==="style"&&typeof node[k2]==="object"){Object.assign(node.__props.style,cpy[k2])}else if(k2==="className")node.__props.setAttribute("class",cpy[k2]);else if(!k2.includes("outer"))node.__props[k2]=cpy[k2]}if(node.__attributes){for(const k2 in node.__attributes){if(k2==="style"&&typeof node.__attributes[k2]==="object"){Object.assign(node.__props.style,node.__attributes[k2])}else if(k2==="className")node.__props.setAttribute("class",node.__attributes[k2]);else if(!k2.includes("outer"))node.__props[k2]=node.__attributes[k2]}}node.__proxyObject(node.__props);for(const k2 of keys){if(typeof cpy[k2]==="function"){let fn=cpy[k2];node.__props[k2]=(...inp)=>{let res=fn(...inp);node.__node.state.triggerEvent(node.__node.unique+"."+k2,res)}}}if(node.__attributes){for(const k2 in node.__attributes){if(typeof cpy[k2]==="function"){let fn=node.__attributes[k2];node.__props[k2]=(...inp)=>{let res=fn(...inp);node.__node.state.triggerEvent(node.__node.unique+"."+k2,res)}}}}}else if(node.__props instanceof HTMLElement){let cpy=Object.assign({},node);let keys=Object.getOwnPropertyNames(cpy);for(const k2 of keys){if(k2==="style"&&typeof node[k2]==="object"){Object.assign(node.__props.style,cpy[k2])}else if(k2==="className")node.__props.setAttribute("class",cpy[k2]);else if(!k2.includes("outer"))node.__props[k2]=cpy[k2]}if(node.__attributes){for(const k2 in node.__attributes){if(k2==="style"&&typeof node.__attributes[k2]==="object"){Object.assign(node.__props.style,node.__attributes[k2])}else if(k2==="className")node.__props.setAttribute("class",cpy[k2]);else if(!k2.includes("outer"))node.__props[k2]=node.__attributes[k2]}}node.__proxyObject(node.__props);for(const k2 of keys){if(typeof cpy[k2]==="function"){let fn=cpy[k2];node.__props[k2]=(...inp)=>{let res=fn(...inp);node.__node.state.triggerEvent(node.__node.unique+"."+k2,res)};node[k2]=node.__props[k2]}}if(node.__attributes){for(const k2 in node.__attributes){if(typeof cpy[k2]==="function"){let fn=node.__attributes[k2];node.__props[k2]=(...inp)=>{let res=fn(...inp);node.__node.state.triggerEvent(node.__node.unique+"."+k2,res)};node[k2]=node.__props[k2]}}}if(node.__onresize)window.addEventListener("resize",node.__onresize)}if(node.__props instanceof HTMLElement){node.__props.id=key;node.__props.node=node;node.__addOnconnected(n=>{if(!(node.__props instanceof HTMLBodyElement||node.__props instanceof HTMLHeadElement)&&n.__props.parentNode)n.__props.remove();if(properties.parentNode){if(typeof properties.parentNode==="string"&&document.getElementById(properties.parentNode))document.getElementById(properties.parentNode)?.appendChild(n.__props);else if(properties.parentNode instanceof HTMLElement)properties.parentNode.appendChild(n.__props)}else if(parent?.__props instanceof HTMLElement){parent.__props.appendChild(node.__props)}else if(typeof graph.parentNode==="string"&&document.getElementById(properties.parentNode)){document.getElementById(properties.parentNode)?.appendChild(graph.__props)}else if(graph.parentNode instanceof HTMLElement){graph.parentNode.appendChild(node.__props)}else if(!(node.__props instanceof HTMLBodyElement||node.__props instanceof HTMLHeadElement))document.body.appendChild(node.__props);if(node.__onrender&&!(node.__props instanceof DOMElement)&&!node.__template)setTimeout(()=>{node.__onrender(node.__props)},.01)});node.__addOndisconnected(n=>{n.__props.remove();if(typeof n.__onremove==="function"){n.__onremove(n.__props)}if(n.__onresize){window.removeEventListener("resize",n.__onresize)}})}};var HTTPfrontend=class _HTTPfrontend extends L{name="http";fetchProxied=false;listening={};constructor(options,path,fetched){super(options);this.load(this);this.listen(path,fetched)}static request=options=>{const xhr=new XMLHttpRequest;if(options.responseType)xhr.responseType=options.responseType;else options.responseType="json";if(options.mimeType){xhr.overrideMimeType(options.mimeType)}if(options.onload)xhr.addEventListener("load",options.onload,false);if(options.onprogress)xhr.addEventListener("progress",options.onprogress,false);if(options.onabort)xhr.addEventListener("abort",options.onabort,false);if(options.onloadend)xhr.addEventListener("loadend",options.onloadend,false);if(options.onerror)xhr.addEventListener("error",options.onerror,false);xhr.open(options.method,options.url,true,options.user,options.pass);if(!options.onerror)xhr.onerror=function(){xhr.abort()};xhr.send(options.data);return xhr};GET=(url="http://localhost:8080/ping",type="",mimeType)=>{if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method:"GET",url,responseType:type,mimeType,onload:ev=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url instanceof URL)url=url.toString();this.setState({[url]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};POST=(message,url="http://localhost:8080/echo",type="",mimeType)=>{if(typeof message==="object"&&!message.byteLength&&(type==="json"||type==="text"||!type)){message=JSON.stringify(message)}if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method:"POST",url,data:message,responseType:type,mimeType,onload:ev=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url instanceof URL)url=url.toString();this.setState({[url]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};transmit=(message,url)=>{let obj=message;if(typeof obj==="object"&&!obj.byteLength){message=JSON.stringify(obj)}if(obj?.method?.toLowerCase()=="get"||message?.toLowerCase()==="get")return this.GET(url);return this.POST(message,url)};transponder=(url,message,type="",mimeType)=>{if(typeof message==="object")message=JSON.stringify(message);let method="GET";if(message){method="POST"}if(type==="json")mimeType="application/json";else return new Promise((resolve,reject)=>{let xhr=_HTTPfrontend.request({method,url,data:message,responseType:type,onload:ev=>{let body=xhr.response;if(typeof body==="string"){let substr=body.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))body=body.replace(/\\/g,"");if(body[0]==='"'){body=body.substring(1,body.length-1)};body=JSON.parse(body)}}if(typeof body?.method==="string"){return resolve(this.handleMethod(body.route,body.method,body.args))}else if(typeof body?.route==="string"){return resolve(this.handleServiceMessage(body))}else if(typeof body?.node==="string"||body.node instanceof y){return resolve(this.handleGraphNodeCall(body.node,body.args))}else return resolve(body)},onabort:er=>{reject(er)}})}).catch(console.error)};listen=(path="0",fetched=async(clone,args,response)=>{const result=await clone.text();const returned=this.receive(result);this.setState({[response.url]:returned})})=>{this.listening[path]={};let listenerId=`${path}${Math.floor(Math.random()*1e15)}`;this.listening[path][listenerId]=fetched;if(!this.fetchProxied){globalThis.fetch=new Proxy(globalThis.fetch,{apply(fetch,that,args){const result=fetch.apply(that,args);result.then(response=>{if(!response.ok)return;if(this.listening["0"]){for(const key in this.listeners){const clone=response.clone();this.listening["0"][key](clone,args,response)}}else{for(const key in this.listening){if(response.url.includes(key)){for(const key2 in this.listening[path]){const clone=response.clone();this.listening[path][key2](clone,args,response)}break}}}}).catch(er=>{console.error(er)});return result}});this.fetchProxied=true}return listenerId};stopListening=(path,listener)=>{if(!path&&path!==0){for(const key in this.listening)delete this.listening[key]}else{if(!listener)delete this.listening[path];else delete this.listening[listener]}}};var SSEfrontend=class extends L{name="sse";eventsources={};connections={eventsources:this.eventsources};constructor(options){super(options);this.load(this)}openSSE=options=>{let source=new EventSource(options.url);let sse={source,type:"eventsource",...options};if(!("keepState"in options))options.keepState=true;if(!options.events)options.events={};let close;if(options.events.close){close=options.events.close}options.events.close=ev=>{if(sse.onclose)sse.onclose(ev,sse);if(close)close(ev,sse);delete this.eventsources[options.url]};let open;if(options.events.open){open=options.events.open}options.events.open=ev=>{if(sse.onopen)sse.onopen(ev,sse);if(open)open(ev,sse)};let error;if(options.events.error){error=options.events.error}options.events.error=ev=>{if(sse.onerror)sse.onerror(ev,sse);if(error)error(ev,sse)};let message;if(options.events.message){message=options.events.message}if(!sse.onmessage){sse.onmessage=(ev,sse2)=>{let data=ev.data;if(data){if(typeof data==="string"){let substr=data.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))data=data.replace(/\\/g,"");if(data[0]==='"'){data=data.substring(1,data.length-1)};data=JSON.parse(data);if(data.route==="setId"&&sse2){sse2._id=data.args;options.events.message=(e,sse3)=>{const result2=this.receive(e.data,sse3);if(options.keepState)this.setState({[options.url]:e.data})}}}}}const result=this.receive(ev.data,sse2);if(options.keepState)this.setState({[options.url]:data})}}options.events.message=ev=>{if(sse.onmessage)sse.onmessage(ev,sse);if(message)message(ev,sse)};if(!options.events.error)options.events.error=(ev,sse2)=>{this.terminate(sse2);delete this.eventsources[options.url]};if(options.events){if(!options.evoptions)options.evoptions=false;for(const key in options.events){if(typeof options.events[key]!=="function"){options.events[key]=ev=>{const result=this.receive(ev.data,sse);if(options.keepState)this.setState({[options.url]:result})}}else{let l=options.events[key];options.events[key]=ev=>{l(ev,sse)}}source.addEventListener(key,options.events[key],options.evoptions)}}let send=message2=>{return this.transmit(message2,options.url)};let request=(message2,method,sessionId)=>{return this.request(message2,options.url,method,sessionId)};let post=(route,args,method)=>{let message2={route,args};if(method)message2.method=method;return this.transmit(message2,options.url)};let run=(route,args,method,sessionId)=>{return this.request({route,args},options.url,method,sessionId)};let subscribe=(route,callback,args,key,subInput)=>{return this.subscribeToSSE(route,options.url,callback,args,key,subInput,sse._id)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let terminate=()=>{return this.terminate(options.url)};sse.send=send;sse.request=request;sse.post=post;sse.run=run;sse.subscribe=subscribe;sse.unsubscribe=unsubscribe;sse.terminate=terminate;sse.graph=this;this.eventsources[options.url]=sse;return sse};open=this.openSSE;POST=(message,url="http://localhost:8080/echo",type="",mimeType)=>{if(typeof message==="number"||typeof message==="object"&&!message.byteLength&&(type==="json"||type==="text"||!type)){message=JSON.stringify(message)}if(type==="json")mimeType="application/json";return new Promise((resolve,reject)=>{let xhr=HTTPfrontend.request({method:"POST",url,data:message,responseType:type,mimeType,onload:ev=>{let data;if(xhr.responseType===""||xhr.responseType==="text")data=xhr.responseText;else data=xhr.response;if(url instanceof URL)url=url.toString();this.setState({[url]:data});resolve(data)},onabort:er=>{reject(er)}})}).catch(console.error)};transmit=(message,url)=>{return this.POST(message,url,"json")};request=(message,url,method,sessionId)=>{return new Promise((res,rej)=>{let callbackId=`${Math.random()}`;let req={route:"runRequest",args:[message,url,callbackId,sessionId]};if(method)req.method=method;let evs=this.eventsources[url].source;let onmessage=ev=>{let data=ev.data;if(typeof data==="string"){if(data.includes("callbackId"))data=JSON.parse(data)}if(typeof data==="object"){if(data.callbackId===callbackId){evs.removeEventListener("message",onmessage);res(data.args)}}};evs.addEventListener("message",onmessage);this.POST(message,url,"json")})};runRequest=(message,url,callbackId,sessionId)=>{let res=this.receive(message);if(url){if(res instanceof Promise){res.then(r=>{let message2={args:r,callbackId,sessionId};this.POST(message2,url,"json")})}else{let message2={args:res,callbackId,sessionId};this.POST(message2,url,"json")}}return res};subscribeSSE=(route,url,args,key,subInput)=>{if(this.restrict?.[route])return void 0;return this.subscribe(route,res=>{this.POST(res,url,"json")},args,key,subInput)};subscribeToSSE=(route,url,callback,args,key,subInput,sessionId)=>{if(url){this.__node.state.subscribeEvent(url,res=>{let msg=JSON.parse(res);if(msg?.callbackId===route){if(!callback)this.setState({[url]:msg.args});else if(typeof callback==="string"){this.run(callback,msg.args)}else callback(msg.args)}});return this.eventsources[url].run("subscribeSSE",[route,url,args,key,subInput,sessionId])}};terminate=sse=>{if(typeof sse==="string"){let str=sse;sse=this.eventsources[sse];delete this.eventsources[str]}if(!sse)return;if(typeof sse==="object"){if(sse.source){sse=sse.source}if(sse instanceof EventSource){if(sse.readyState!==2)sse.close()}}}};var WSSfrontend=class extends L{name="wss";sockets={};connections={sockets:this.sockets};constructor(options){super(options);this.load(this)}loadWebSocketRoute=node=>{let wsInfo=this.openWS(node);if(!wsInfo.__ondisconnected){wsInfo.__addOndisconnected(()=>{wsInfo.terminate()})}if(!node.__operator){node.__operator=(...args)=>{if(node.callback){if(!this.__node.nodes.get(node.__node.tag)?.__children)wsInfo.post(node.callback,args);else return wsInfo.run(node.callback,args)}else{if(!this.__node.nodes.get(node.__node.tag)?.__children)wsInfo.send(args);else return wsInfo.request(args)}}}if(!node.__ondisconnected){let ondelete=rt=>{rt?.terminate()};node.__addOndisconnected(ondelete)}return wsInfo};socketloader={"websockets":(node,parent,graph,roots)=>{node._id=node.__node.tag;let ws=this.loadWebSocketRoute(node);Object.assign(node,ws);if(parent&&parent.type==="socket"){let parentWs=this.sockets[parent._id];if(node.parentRoute){parentWs.subscribe(node.parentRoute,node.__operator)}}}};openWS=(options={host:"localhost",port:7e3,path:void 0,protocol:"ws"})=>{let protocol=options.protocol;if(!protocol)protocol="ws";let address=`${protocol}://${options.host}`;if(!("keepState"in options))options.keepState=true;if(options.port)address+=":"+options.port;if(options.path&&!options.path?.startsWith("/"))address+="/";if(options.path)address+=options.path;if(this.sockets[address]?.socket){if(this.sockets[address].socket.readyState===this.sockets[address].socket.OPEN)this.sockets[address].socket.close()}const socket=new WebSocket(address);if(!options.onmessage){if(!options._id){options.onmessage=(data,ws,wsinfo)=>{if(data){if(typeof data==="string"){if(options.debug){console.log("Message from ",address,": ",data)}let substr=data.substring(0,8);if(substr.includes("{")||substr.includes("[")){if(substr.includes("\\"))data=data.replace(/\\/g,"");if(data[0]==='"'){data=data.substring(1,data.length-1)};data=JSON.parse(data);if(data.route==="setId"){this.sockets[address]._id=data.args;options.onmessage=(data2,ws2,wsinfo2)=>{if(options.debug){console.log("Message from ",address,": ",data2)}this.receive(data2);if(options.keepState){this.setState({[address]:data2})}}}}}}let res=this.receive(data);if(options.keepState)this.setState({[address]:data})}}else{options.onmessage=(data,ws,wsinfo)=>{if(options.debug){console.log("Message from ",socket.url,": ",data)}this.receive(data,socket,this.sockets[address]);if(options.keepState){this.setState({[address]:data})}}}}if(options.onmessage){socket.addEventListener("message",ev=>{this.sockets[address].onmessage(ev.data,socket,this.sockets[address])})}socket.addEventListener("open",ev=>{if(this.sockets[address].onopen)this.sockets[address].onopen(ev,socket,this.sockets[address])});socket.addEventListener("close",ev=>{let obj=this.sockets[address];let onclose=obj.onclose;delete this.sockets[address];this.remove(address);if(onclose)onclose(ev,socket,obj)});socket.addEventListener("error",ev=>{if(this.sockets[address].onerror)this.sockets[address].onerror(ev,socket,this.sockets[address])});let send=message=>{return this.transmit(message,socket)};let post=(route,args,method)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,socket)};let run=(route,args,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},this.sockets[address]._id,callbackId]};if(method)req.args[0].method=method;let onmessage=ev=>{let data=ev.data;if(typeof data==="string"&&data.indexOf("{")>-1)data=JSON.parse(ev.data);if(typeof data==="object"){if(data.callbackId===callbackId){socket.removeEventListener("message",onmessage);res(data.args)}}};socket.addEventListener("message",onmessage);this.transmit(req,socket)})};let request=(message,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,this.sockets[address]._id,callbackId]};if(method)req.method=method;let onmessage=ev=>{let data=ev.data;if(typeof data==="string"&&data.indexOf("{")>-1)data=JSON.parse(ev.data);if(typeof data==="object"){if(data.callbackId===callbackId){socket.removeEventListener("message",onmessage);res(data.args)}}};socket.addEventListener("message",onmessage);this.transmit(req,socket)})};let subscribe=(route,callback,args,key,subInput)=>{return this.subscribeToSocket(route,this.sockets[address]._id,callback,args,key,subInput)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let terminate=()=>{return this.terminate(address)};Object.assign(options,{type:"socket",socket,address,send,post,run,request,subscribe,unsubscribe,terminate});if(!(options instanceof y)){let node=this.add(options);node.__addOndisconnected(function(){terminate()});options=node}this.sockets[address]=options;return options};open=this.openWS;transmit=(data,ws)=>{if(typeof data==="object"&&(data?.route||data?.node||typeof data.arrayBuffer!=="function"&&typeof data.byteLength!=="number")||typeof data==="number")data=JSON.stringify(data);if(!ws){let s=this.sockets[Object.keys(this.sockets)[0]];if(s)ws=s.socket}if(ws instanceof WebSocket&&ws?.readyState===1)ws.send(data);return true};terminate=ws=>{let str;if(!ws){let keys=Object.keys(this.sockets);for(const key in keys){this.terminate(key)}}else if(typeof ws==="string"){str=ws;for(const k2 in this.sockets){if(k2.includes(ws)||this.sockets[k2]._id===k2){ws=this.sockets[k2].socket;break}}}if(ws instanceof WebSocket){if(ws.readyState===ws.OPEN)ws.close();if(this.get(str?str:ws.url))this.remove(str?str:ws.url)}return true};request=(message,ws,_id,method)=>{let callbackId=`${Math.random()}`;let req={route:"runRequest",args:[message,_id,callbackId]};if(method)req.method=method;return new Promise((res,rej)=>{let onmessage=ev=>{let data=ev.data;if(typeof data==="string"){if(data.includes("callbackId"))data=JSON.parse(data)}if(typeof data==="object"){if(data.callbackId===callbackId){ws.removeEventListener("message",onmessage);res(data.args)}}};ws.addEventListener("message",onmessage);ws.send(JSON.stringify(req))})};runRequest=(message,ws,callbackId)=>{let res=this.receive(message);if(typeof ws==="string"){for(const s in this.sockets){if(s===ws||this.sockets[s]._id===ws){ws=this.sockets[s].socket;break}}}if(ws){if(res instanceof Promise){res.then(v=>{res={args:v,callbackId};if(ws instanceof WebSocket)ws.send(JSON.stringify(res))})}else{res={args:res,callbackId};if(ws instanceof WebSocket)ws.send(JSON.stringify(res))}}return res};subscribeSocket=(route,socket,args,key,subInput)=>{if(this.restrict?.[route])return void 0;if(typeof socket==="string"&&this.sockets[socket]){socket=this.sockets[socket].socket}if(typeof socket==="object"){return this.subscribe(route,res=>{if(socket.readyState===socket.OPEN){if(res instanceof Promise){res.then(r=>{socket.send(JSON.stringify({args:r,callbackId:route}))})}else{socket.send(JSON.stringify({args:res,callbackId:route}))}}},args,key,subInput)}};subscribeToSocket=(route,socketId,callback,args,key,subInput)=>{if(typeof socketId==="string"&&this.sockets[socketId]){this.__node.state.subscribeEvent(socketId,res=>{let msg=JSON.parse(res);if(msg?.callbackId===route){if(!callback)this.setState({[socketId]:msg.args});else if(typeof callback==="string"){this.run(callback,msg.args)}else callback(msg.args)}});return this.sockets[socketId].request({route:"subscribeSocket",args:[route,socketId,args,key,subInput]})}}};var WebRTCfrontend=class extends L{name="webrtc";rtc={};unanswered={};iceServers=[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]},{urls:["stun:stun2.l.google.com:19302"]},{urls:["stun:stun3.l.google.com:19302"]},{urls:["stun:stun4.l.google.com:19302"]}];connections={rtc:this.rtc};constructor(options,iceServers){super(options);if(iceServers)this.iceServers=iceServers;this.load(this)}openRTC=async options=>{if(!options)options={};if(!options._id)options._id=`rtc${Math.floor(Math.random()*1e15)}`;if(!options.config)options.config={iceServers:this.iceServers};if(!this.rtc[options._id]){let rtc=new RTCPeerConnection(options.config);if(!options.channels)options.channels={"data":true};let firstChannel;for(const key in options.channels){firstChannel=key;break}let send=message=>{return this.transmit(message,options._id,options.channels[firstChannel])};let post=(route,args,method)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,options._id,options.channels[firstChannel])};let run=(route,args,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options._id,callbackId]};if(method)req.args[0].method=method;let sub;let ondata=data=>{if(typeof data==="string"&&data.indexOf("{")>-1)data=JSON.parse(data);if(typeof data==="object"){if(data.callbackId===callbackId){this.unsubscribe(options._id,sub);res(data.args)}}};sub=this.subscribe(options._id,ondata);this.transmit(req,options._id,options.channels[firstChannel])})};let request=(message,method)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options._id,callbackId]};if(method)req.method=method;let sub;let ondata=data=>{if(typeof data==="string"&&data.indexOf("{")>-1)data=JSON.parse(data);if(typeof data==="object"){if(data.callbackId===callbackId){this.unsubscribe(options._id,sub);res(data.args)}}};sub=this.subscribe(options._id,ondata);this.transmit(req,options._id,options.channels[firstChannel])})};let subscribe=(route,callback,args,key,subInput,channelId)=>{return this.subscribeToRTC(route,options._id,channelId?channelId:firstChannel,callback,args,key,subInput)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let terminate=()=>{return this.terminate(options._id)};this.rtc[options._id]={rtc,_id:options._id,request,run,post,send,subscribe,unsubscribe,terminate,graph:this,...options};const setMessageChannelHandle=channel=>{if(!this.rtc[options._id].ondata){this.rtc[options._id].ondata=mev=>{this.receive(mev.data,channel,this.rtc[options._id]);this.setState({[options._id]:mev.data})};channel.addEventListener("message",mev=>{if(this.rtc[options._id].ondata)this.rtc[options._id].ondata(mev,channel,this.rtc[options._id])})}else{channel.addEventListener("message",mev=>{if(this.rtc[options._id].ondata)this.rtc[options._id].ondata(mev,channel,this.rtc[options._id])})}};if(this.rtc[options._id].channels){for(const channel in this.rtc[options._id].channels){if(this.rtc[options._id].channels[channel]instanceof RTCDataChannel){}else if(typeof this.rtc[options._id].channels[channel]==="object"){this.rtc[options._id].channels[channel]=this.addDataChannel(rtc,channel,this.rtc[options._id].channels[channel])}else{this.rtc[options._id].channels[channel]=this.addDataChannel(rtc,channel)}setMessageChannelHandle(this.rtc[options._id].channels[channel])}}rtc.ontrack=ev=>{if(!this.rtc[options._id].receivers)this.rtc[options._id].receivers=[];this.rtc[options._id].receivers.push(ev.receiver);if(!this.rtc[options._id].streams)this.rtc[options._id].streams=[];this.rtc[options._id].streams.push(...ev.streams);let rlength=this.rtc[options._id].receivers.length;let slength=this.rtc[options._id].streams.length;ev.streams.forEach(s=>{s.addEventListener("removetrack",ev2=>{this.rtc[options._id].receivers[rlength]=void 0;this.rtc[options._id].streams[slength]=void 0;if(this.rtc[options._id].removetrack)this.rtc[options._id].removetrack(ev2)})});if(this.rtc[options._id].ontrack)this.rtc[options._id].ontrack(ev)};rtc.ondatachannel=ev=>{this.rtc[options._id].channels[ev.channel.label]=ev.channel;setMessageChannelHandle(ev.channel);if(this.rtc[options._id].ondatachannel)this.rtc[options._id].ondatachannel(ev)};rtc.onicecandidate=ev=>{if(this.rtc[options._id].onicecandidate)this.rtc[options._id].onicecandidate(ev)};rtc.onicecandidateerror=ev=>{if(this.rtc[options._id].onicecandidateerror)this.rtc[options._id].onicecandidateerror(ev)};let initialOffer=this.rtc[options._id].description===void 0;rtc.onnegotiationneeded=async ev=>{if(!initialOffer){const offer=await rtc.createOffer(this.rtc[options._id].offer);if(rtc.signalingState!="stable")return;await rtc.setLocalDescription(offer);if(this.rtc[options._id].onnegotiationneeded)this.rtc[options._id].onnegotiationneeded(ev,rtc.localDescription)}};rtc.oniceconnectionstatechange=ev=>{if(this.rtc[options._id].oniceconnectionstatechange)this.rtc[options._id].oniceconnectionstatechange(ev)};rtc.onconnectionstatechange=ev=>{if(this.rtc[options._id].onconnectionstatechange)this.rtc[options._id].onconnectionstatechange(ev)};rtc.addEventListener("connectionstatechange",ev=>{if(rtc.connectionState==="closed"||rtc.connectionState==="failed"){if(this.rtc[options._id].onclose){this.rtc[options._id].onclose(this.rtc[options._id])}delete this.rtc[options._id]}});if(!this.rtc[options._id].onicecandidate)this.rtc[options._id].onicecandidate=ev=>{if(ev.candidate){let icecandidate=ev.candidate;if(!this.rtc[options._id].candidates)this.rtc[options._id].candidates={};this.rtc[options._id].candidates[`candidate${Math.floor(Math.random()*1e15)}`]=icecandidate}};if(!options.description)return await new Promise((res,rej)=>{this.rtc[options._id].rtc.createOffer(options.offer).then(offer=>this.rtc[options._id].rtc.setLocalDescription(offer)).then(()=>{initialOffer=false;res(this.rtc[options._id])})})}else{Object.assign(this.rtc[options._id],options)}if(options.description){this.rtc[options._id].polite=true;await this.negotiateCall(options._id,options.description,true)}if(options.candidates){for(const prop in options.candidates){const candidate=new RTCIceCandidate(options.candidates[prop]);this.rtc[options._id].rtc.addIceCandidate(candidate).catch(console.error)}}return this.rtc[options._id]};open=this.openRTC;addIceCandidate=(rtc,candidate)=>{if(typeof rtc==="string")rtc=this.rtc[rtc]?.rtc;if(typeof candidate==="string")candidate=JSON.parse(decodeURIComponent(candidate));if(rtc&&rtc.remoteDescription)return rtc.addIceCandidate(candidate)};receiveCallInformation=async options=>{if(!options._id)options._id=`rtc${Math.floor(Math.random()*1e15)}`;if(this.rtc[options._id]){if(options.candidates){for(const key in options.candidates)this.addIceCandidate(this.rtc[options._id].rtc,options.candidates[key]);delete options.candidates}Object.assign(this.rtc[options._id],options)}else if(this.unanswered[options._id]){this.recursivelyAssign(this.unanswered[options._id],options)}else this.unanswered[options._id]=options;return options._id};answerCall=options=>{if(typeof options==="string")options=this.unanswered[options];delete this.unanswered[options._id];return this.openRTC(options)};rejectCall=options=>{if(typeof options==="string")options=this.unanswered[options];delete this.unanswered[options._id];return true};negotiateCall=async(rtc,description,polite)=>{if(typeof rtc==="string"){if(polite===void 0)polite=this.rtc[rtc].description!==void 0;rtc=this.rtc[rtc].rtc}if(typeof description==="string")description=new RTCSessionDescription(JSON.parse(decodeURIComponent(description)));if(description.type==="offer"&&rtc.signalingState!=="stable"){if(!polite)return;await Promise.all([rtc.setLocalDescription({type:"rollback"}),rtc.setRemoteDescription(description)]);return encodeURIComponent(JSON.stringify(rtc.localDescription))}else{await rtc.setRemoteDescription(description)}if(description.type=="offer"){await rtc.setLocalDescription(await rtc.createAnswer());return encodeURIComponent(JSON.stringify(rtc.localDescription))}};createOffer(rtc,options){if(typeof rtc==="string")rtc=this.rtc[rtc].rtc;if(typeof options==="string")options=this.rtc[options];return new Promise((res,rej)=>{if(!rtc)rej(void 0);rtc.createOffer(options.offer).then(offer=>rtc.setLocalDescription(offer)).then(()=>{let description=encodeURIComponent(JSON.stringify(rtc.localDescription));res(description)})})}createAnswer(rtc,options){if(typeof rtc==="string")rtc=this.rtc[rtc]?.rtc;if(typeof options==="string")options=this.rtc[options];return new Promise((res,rej)=>{if(!rtc)rej(void 0);rtc.createAnswer(options.answer).then(answer=>rtc.setLocalDescription(answer)).then(()=>{let description=encodeURIComponent(JSON.stringify(rtc.localDescription));res(description)})})}answerPeer=(rtc,options)=>{if(typeof rtc==="string"){let cpy=Object.assign(this.rtc[rtc],options);delete cpy.description;delete cpy.candidates;Object.assign(this.rtc[rtc],cpy);rtc=this.rtc[rtc]?.rtc}if(typeof options==="string")options=this.rtc[options];return new Promise((res,rej)=>{if(typeof options.description==="string"){options.description=JSON.parse(decodeURIComponent(options.description))}const description=new RTCSessionDescription(options.description);rtc.setRemoteDescription(description).then(()=>{if(options.candidates){for(const prop in options.candidates){const candidate=new RTCIceCandidate(options.candidates[prop]);if(this.rtc[options._id])this.rtc[options._id].candidates[prop]=options.candidates[prop];rtc.addIceCandidate(candidate).catch(console.error)}}if(description.type==="offer"){this.rtc[options._id].rtc.createAnswer(options.answer).then(a=>{this.rtc[options._id].rtc.setLocalDescription(a)})}res(this.rtc[options._id]?this.rtc[options._id]:rtc)}).catch(rej)})};createStream=options=>{let stream=new MediaStream;for(const key in options){let track=options[key].track;if(!(track instanceof MediaStreamTrack)&&typeof track==="object"){track=new MediaStreamTrack;track.applyConstraints(options[key].track);stream.addTrack(track)}if(track instanceof MediaStreamTrack){stream.addTrack(track);track.onmute=options[key].onmute;track.onunmute=options[key].onunmute;track.onended=options[key].onended}}return stream};addUserMedia=(rtc,options={audio:true,video:{optional:[{minWidth:320},{minWidth:640},{minWidth:1024},{minWidth:1280},{minWidth:1920},{minWidth:2560}]}},info)=>{return new Promise(async(res,rej)=>{let RTCRtpSenders=[];let stream=await navigator.mediaDevices.getUserMedia(options);if(stream){let tracks=stream.getTracks();tracks.forEach(track=>{let sender=rtc.addTrack(track,stream);if(track.kind==="video"&&info){info.videoSender=sender;info.videoStream=stream}if(track.kind==="audio"&&info){info.audioSender=sender;info.audioStream=stream}RTCRtpSenders.push(sender)});let str=stream;if(info)info.senders=info.senders?[...info.senders,...RTCRtpSenders]:RTCRtpSenders;res(str)}})};addTrack=(rtc,track,stream)=>{return rtc.addTrack(track,stream)};removeTrack=(rtc,sender)=>{rtc.removeTrack(sender);return true};addDataChannel=(rtc,name,options)=>{return rtc.createDataChannel(name,options)};enableAudio=async(call,audioOptions=true)=>{if(call.audioStream)this.disableAudio(call);let stream=await this.addUserMedia(call.rtc,{audio:audioOptions,video:false},call);if(audioOptions?.deviceId)call.audioSender.deviceId=audioOptions.deviceId;return stream};enableVideo=async(call,videoOptions={optional:[{minWidth:320},{minWidth:640},{minWidth:1024},{minWidth:1280},{minWidth:1920},{minWidth:2560},{minWidth:3840}]},includeAudio=false)=>{if(call.videoStream)this.disableVideo(call);let stream=await this.addUserMedia(call.rtc,{audio:includeAudio,video:videoOptions?videoOptions:{optional:[{minWidth:320},{minWidth:640},{minWidth:1024},{minWidth:1280},{minWidth:1920},{minWidth:2560},{minWidth:3840}]}},call);if(videoOptions?.deviceId)call.videoSender.deviceId=videoOptions.deviceId;if(includeAudio){if(includeAudio?.deviceId)call.audioSender.deviceId=includeAudio.deviceId;else if(videoOptions?.deviceId)call.audioSender.deviceId=videoOptions.deviceId}return stream};disableAudio(call){if(call.audioSender){call.senders?.find((s,i3)=>{if(call.audioStream?.getAudioTracks()[0].id===s.track.id){call.senders.splice(i3,1);return true}});call.rtc.removeTrack(call.audioSender);call.audioSender=void 0}call.audioStream?.getTracks().forEach(track=>{if(track.kind==="audio")track.stop()});call.audioStream=void 0}disableVideo(call){if(call.videoSender){call.senders?.find((s,i3)=>{if(call.videoStream?.getVideoTracks()[0].id===s.track.id){call.senders.splice(i3,1);return true}});call.rtc.removeTrack(call.videoSender);call.videoSender=void 0}call.videoStream?.getTracks().forEach(track=>{if(track.kind==="video")track.stop()});call.videoStream=void 0}transmit=(data,id,channel)=>{if(typeof data==="object"&&(data.route||data.node||!data.byteLength&&typeof data.arrayBuffer!=="function")||typeof data==="number")data=JSON.stringify(data);if(!channel&&id){let keys=Object.keys(this.rtc[id].channels);if(keys[0])channel=this.rtc[id].channels[keys[0]]}if(typeof channel==="string"){if(id){channel=this.rtc[id].channels[channel]}else{for(const id2 in this.rtc){if(this.rtc[id2].channels[channel]instanceof RTCDataChannel)this.rtc[id2].channels[channel].send(data)}}}if(channel instanceof RTCDataChannel)channel.send(data);return true};terminate=rtc=>{let tx;if(typeof rtc==="string"){let room=this.rtc[rtc];delete this.rtc[rtc];if(room){tx=room.rtc}}else if(typeof rtc==="object"){tx=rtc.rtc}if(rtc instanceof RTCPeerConnection&&rtc.signalingState!=="closed"){rtc.close()}else if(tx&&tx.signalingState!=="closed"){if(tx)tx.close()}return true};request=(message,channel,_id,method)=>{let callbackId=`${Math.random()}`;let req={route:"runRequest",args:[message,_id,callbackId]};if(method)req.method=method;return new Promise((res,rej)=>{let onmessage=ev=>{let data=ev.data;if(typeof data==="string"&&data.indexOf("{")>-1)data=JSON.parse(ev.data);if(typeof data==="object"){if(data.callbackId===callbackId){channel.removeEventListener("message",onmessage);res(data.args)}}};channel.addEventListener("message",onmessage);channel.send(JSON.stringify(req))})};runRequest=(message,channelOrRtcId,callbackId)=>{let res=this.receive(message);if(channelOrRtcId){if(typeof channelOrRtcId==="string"){for(const key in this.rtc){if(key===channelOrRtcId){channelOrRtcId=this.rtc[key].channels.data?this.rtc[key].channels.data:this.rtc[key].channels[Object.keys(this.rtc[key].channels)[0]];break}}}if(res instanceof Promise)res.then(v=>{res={args:v,callbackId};if(channelOrRtcId instanceof RTCDataChannel)channelOrRtcId.send(JSON.stringify(res));return res});else{res={args:res,callbackId};if(channelOrRtcId instanceof RTCDataChannel)channelOrRtcId.send(JSON.stringify(res))}}return res};subscribeRTC=(route,rtcId,args,key,subInput,channel)=>{if(this.restrict?.[route])return void 0;if(typeof channel==="string"&&this.rtc[rtcId]){channel=this.rtc[rtcId].channels[channel]}else if(!channel){channel=this.rtc[rtcId].channels[Object.keys(this.rtc[rtcId].channels)[0]]}return this.subscribe(route,res=>{if(res instanceof Promise){res.then(r=>{channel.send(JSON.stringify({args:r,callbackId:route}))})}else{channel.send(JSON.stringify({args:res,callbackId:route}))}},args,key,subInput)};subscribeToRTC=(route,rtcId,channelId,callback,args,key,subInput)=>{if(typeof channelId==="string"&&this.rtc[rtcId]){let c=this.rtc[rtcId];let channel=c.channels[channelId];if(channel){this.__node.state.subscribeEvent(rtcId,res=>{if(res?.callbackId===route){if(!callback)this.setState({[rtcId]:res.args});else if(typeof callback==="string"){this.run(callback,res.args)}else callback(res.args)}});return c.request({route:"subscribeRTC",args:[route,rtcId,args,key,subInput,channelId]})}}}};var ECSService=class extends L{entities={};systems={};entityMap=new Map;entityKeyMap=new Map;order=[];animating=false;entityCt=0;systemCt=0;constructor(options){super(options);this.load(this);if(options?.systems)for(const key in options.systems){this.addSystem(options.systems[key],void 0,void 0,void 0,void 0,options.order)}if(options?.entities){for(const key in options.entities){this.addEntity(options.entities[key],options.entities[key].components)}}}updateEntities=(order=this.order,filter,debug=false)=>{order.forEach(k2=>{if(this.systems[k2]){if(filter){if(debug)debug=performance.now();if(this.entityKeyMap.get(k2).length>0)this.systems[k2].__operator(this.entityMap.get(k2));if(debug)console.log("system",k2,"took",performance.now()-debug,"ms for",Object.keys(this.entityMap.get(k2)).length,"entities")}else{if(debug)debug=performance.now();if(this.entityKeyMap.get(k2).length>0)this.systems[k2].__operator(this.entities);if(debug)console.log("system",k2,"took",performance.now()-debug,"ms for",Object.keys(this.entities).length,"entities")}}})};animateEntities=(filter=true,order)=>{if(!this.animating){this.animating=true;if(typeof requestAnimationFrame!=="undefined"){let anim=()=>{requestAnimationFrame(()=>{if(this.animating){this.updateEntities(order,filter);anim()}})};anim()}else{let looper=()=>{setTimeout(async()=>{if(this.animating){this.updateEntities(order,filter);looper()}},10)};looper()}}};stop=()=>{this.animating=false};start=filter=>{this.animateEntities(filter)};addEntities=(prototype,components={},count=1)=>{let i3=0;let newEntities={};while(i3<count){let entity=this.addEntity(prototype,components);newEntities[entity.__node.tag]=entity;i3++}return Object.keys(newEntities)};addEntity=(prototype={},components={})=>{if(!prototype)return;const entity=this.recursivelyAssign({},prototype);entity.components=components;if(Object.keys(components).length===0){Object.keys(this.systems).forEach(k2=>{components[k2]=true})}if(!entity.__node)entity.__node={};if(entity.__node.tag&&this.entities[entity.__node.tag]){this.entityCt++;let tag=entity.__node.tag+this.entityCt;while(this.entities[entity.__node.tag]){this.entityCt++;entity.__node.tag=`${tag}${this.entityCt}`}}else if(!entity.__node.tag)entity.__node.tag=`entity${Math.floor(Math.random()*1e15)}`;this.add(entity);this.entities[entity.__node.tag]=this.__node.nodes.get(entity.__node.tag);this.setupEntity(this.entities[entity.__node.tag]);return this.entities[entity.__node.tag]};addSystems=(systems={},order)=>{for(const key in systems){systems[key].__node.tag=key;this.addSystem(systems[key],void 0,void 0,void 0,void 0,order)}return this.systems};addSystem=(prototype,setupEntities,setupEntity,operator,remove,order)=>{if(!prototype)return;const system=this.recursivelyAssign({},prototype);if(setupEntities)system.setupEntities=setupEntities;if(setupEntity)system.setupEntity=setupEntity;if(operator)system.__operator=operator;if(remove)system.remove=remove;if(system.__node.tag&&this.systems[system.__node.tag]){this.systemCt++;let tag=system.__node.tag+this.systemCt;while(this.systems[system.__node.tag]){this.systemCt++;system.__node.tag=`${tag}${this.systemCt}`}}else if(!system.__node.tag)system.__node.tag=`system${Math.floor(Math.random()*1e15)}`;this.add(system);this.systems[system.__node.tag]=this.__node.nodes.get(system.__node.tag);if(!this.entityMap.get(system.__node.tag))this.entityMap.set(system.__node.tag,{});if(!this.entityKeyMap.get(system.__node.tag))this.entityKeyMap.set(system.__node.tag,[]);this.systems[system.__node.tag].entities=this.entityMap.get(system.__node.tag);this.systems[system.__node.tag].entityKeys=this.entityKeyMap.get(system.__node.tag);if(this.systems[system.__node.tag]?.setupEntities&&Object.keys(this.entities).length>1){let filtered=this.filterObject(this.entities,(key,v)=>{if(v.components[system.__node.tag])return true});this.systems[system.__node.tag].setupEntities(filtered);Object.assign(this.entityMap.get(system.__node.tag),filtered)}if(!order)this.order.push(system.__node.tag);else this.order=order;return this.systems[system.__node.tag]};setupEntity=entity=>{if(entity?.components){for(const key in entity.components){if(this.systems[key]){this.systems[key].setupEntity(entity);this.entityMap.get(key)[entity.__node.tag]=entity;this.entityKeyMap.get(key).push(entity.__node.tag)}}}};removeEntity=tag=>{const entity=this.entities[tag];for(const key in entity.components){if(this.entityMap.get(key)){delete this.entityMap.get(key)[entity.__node.tag];this.entityKeyMap.get(key).splice(this.entityKeyMap.get(key).indexOf(entity.__node.tag),1)}if(this.systems[key]?.remove){this.systems[key].remove(entity,this.entityMap.get(key))}}delete this.entities[tag];return this.remove(tag)};removeEntities(entities){if(!Array.isArray(entities))entities=Object.keys(entities);entities.forEach(t=>{this.removeEntity(t)})}removeSystem=tag=>{if(this.systems[tag]?.remove){for(const e in this.entityKeyMap.get(tag)){this.systems[tag].remove(this.entityMap.get(tag)[e],this.entityMap.get(tag))}}delete this.systems[tag];this.entityMap.delete(tag);this.entityKeyMap.delete(tag);this.order.splice(this.order.indexOf(tag),1);return this.remove(tag)};filterObject(o,filter){return Object.fromEntries(Object.entries(o).filter(([key,value])=>{filter(key,value)}))}setEntities=(entities,props)=>{if(Array.isArray(entities)){entities.forEach(k2=>{if(this.entities[k2])this.recursivelyAssign(this.entities[k2],props)})}else{for(const key in this.entities){this.setEntity(this.entities[key],props)}}return true};setEntity=(entity,props)=>{return this.recursivelyAssign(entity,props)};bufferValues=(entities,property,keys,buffer)=>{if(!Array.isArray(keys)&&typeof keys==="object")keys=Object.keys(keys);if(!buffer){let entkeys=Object.keys(entities);if(keys)buffer=new Float32Array(entkeys.length*keys.length);else{if(typeof entities[entkeys[0]][property]==="object"){keys=Object.keys(entities[entkeys[0]][property]);buffer=new Float32Array(entkeys.length*keys.length)}else buffer=new Float32Array(entkeys.length)}}let i3=0;for(const key in entities){if(entities[key][property]){if(keys){for(let j2=0;j2<keys.length;j2++){buffer[i3]=entities[key][property][keys[j2]];i3++}}else{buffer[i3]=entities[key][property];i3++}}}return buffer}};export{DOMElement,ECSService,HTTPfrontend,SSEfrontend,WSSfrontend,WebRTCfrontend,addCustomElement,html,htmlloader,wchtmlloader,xml};
